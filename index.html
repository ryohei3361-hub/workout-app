<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Workout Mood</title>

  <style>
    :root{
      --ink:#1f2937;
      --muted:#6b7280;
      --card:rgba(255,255,255,.78);
      --card2:rgba(255,255,255,.62);
      --stroke:rgba(255,255,255,.55);
      --shadow: 0 16px 40px rgba(15,23,42,.12);
      --shadow2: 0 10px 24px rgba(15,23,42,.10);
      --radius: 26px;
      --radius2: 18px;

      --gold1:#ffd76a; --gold2:#ffb800;
      --mint1:#bff1e6; --mint2:#2bd4bd;
      --vio1:#cbbcff;  --vio2:#7c5cff;
      --slate1:#d9dfe8;--slate2:#9aa7b8;

      --cta1:#ffb45a; --cta2:#ff7a45;
      --ctaB1:#6aa9ff;--ctaB2:#2f6bff;

      /* =========================
         ğŸ”¥ ç‚ã®è‰²ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ãƒãƒ¼ãƒãƒ«/ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
         â€» 7ã®å€æ•°ã®ã¨ãã ã‘JSã§ä¸Šæ›¸ãã—ã¾ã™
         ========================= */
      --flame-outer-1:#ffd66b;
      --flame-outer-2:#ff8a2f;
      --flame-outer-3:#ff4d4d;

      --flame-inner-1:#fff2b0;
      --flame-inner-2:#ffd06a;
      --flame-inner-3:#ff7a3a;

      --flame-core-1:#ffffff;
      --flame-core-2:#fff1c6;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color:var(--ink);
      min-height:100vh;
      background: #eef4ff;
      /* âœ… èƒŒæ™¯ç”»åƒï¼ˆã‚­ãƒ©ã‚­ãƒ©ã¯ã“ã®ä¸Šã«é‡ã­ã‚‹ï¼‰ */
      background-image: url("assets/bg.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center top;
    }

    /* âœ¨ ãµã‚ã‚­ãƒ©é‡ã­ï¼ˆèƒŒæ™¯ãŒåœ°å‘³ãªæ™‚ã®ä¿é™ºï¼‰ */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(1.2px 1.2px at 12% 18%, rgba(255,255,255,.9), rgba(255,255,255,0) 60%),
        radial-gradient(1.6px 1.6px at 28% 32%, rgba(255,255,255,.75), rgba(255,255,255,0) 62%),
        radial-gradient(1.1px 1.1px at 63% 14%, rgba(255,255,255,.85), rgba(255,255,255,0) 60%),
        radial-gradient(1.7px 1.7px at 74% 36%, rgba(255,255,255,.65), rgba(255,255,255,0) 62%),
        radial-gradient(1.3px 1.3px at 84% 22%, rgba(255,255,255,.8), rgba(255,255,255,0) 60%),
        radial-gradient(1.2px 1.2px at 18% 72%, rgba(255,255,255,.7), rgba(255,255,255,0) 62%),
        radial-gradient(1.7px 1.7px at 52% 76%, rgba(255,255,255,.65), rgba(255,255,255,0) 62%),
        radial-gradient(1.2px 1.2px at 86% 78%, rgba(255,255,255,.7), rgba(255,255,255,0) 62%);
      opacity:.55;
      filter: blur(.2px);
      animation: twinkle 6s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%,100%{opacity:.45; transform:translateY(0)}
      50%{opacity:.70; transform:translateY(-6px)}
    }

    .app{
      max-width: 920px;
      margin: 0 auto;
      padding: 22px 16px 110px;
    }

    .title{
      text-align:center;
      font-size: 40px;
      letter-spacing: .02em;
      margin: 10px 0 14px;
      text-shadow: 0 6px 18px rgba(15,23,42,.12);
    }

    /* ä¸Šã®ä½“èª¿ã‚¿ãƒ– */
    .moods{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 12px auto 16px;
    }
    .mood{
      user-select:none;
      border: 1px solid rgba(255,255,255,.6);
      background: rgba(255,255,255,.70);
      box-shadow: var(--shadow2);
      border-radius: 18px;
      padding: 12px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight: 800;
      color:#1f2937;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .mood:active{ transform: scale(.98); }

    .mood .ico{ font-size: 18px; opacity:.9 }
    .mood.selected{
      color:#111827;
      border-color: rgba(255,255,255,.75);
    }
    .mood[data-mood="genki"].selected{
      background: linear-gradient(180deg, rgba(255,215,106,.85), rgba(255,184,0,.75));
    }
    .mood[data-mood="futsu"].selected{
      background: linear-gradient(180deg, rgba(191,241,230,.85), rgba(43,212,189,.70));
    }
    .mood[data-mood="shindoi"].selected{
      background: linear-gradient(180deg, rgba(203,188,255,.85), rgba(124,92,255,.65));
      color:#0f172a;
    }
    .mood[data-mood="rest"].selected{
      background: linear-gradient(180deg, rgba(217,223,232,.85), rgba(154,167,184,.60));
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .panel{
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.60);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight: 900;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.65);
      box-shadow: 0 8px 18px rgba(15,23,42,.10);
      margin: 6px 0 8px;
    }
    .chip .ico{font-size:16px}

    .menuTitle{
      font-size: 44px;
      font-weight: 950;
      margin: 6px 0 10px;
      line-height: 1.1;
      letter-spacing: .01em;
      text-shadow: 0 8px 22px rgba(15,23,42,.12);
    }

    .bannerBox{
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.65);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .banner{
      width: 100%;
      height: 140px;          /* âœ… â€œæ ãŒåºƒã„â€å¯¾ç­–ï¼šå›ºå®šé«˜ã• */
      object-fit: contain;    /* âœ… ç”»åƒã¯æ½°ã•ãšä¸­ã«åã‚ã‚‹ */
      display:block;
      border-radius: 16px;
      background: rgba(255,255,255,.30);
    }

    .inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .field{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(255,255,255,.65);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .label{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      color: #334155;
      margin-bottom: 10px;
    }
    .label .miniIco{ font-size: 18px; opacity:.9 }
    .numRow{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    input[type="number"]{
      width: 100%;
      font-size: 42px;
      font-weight: 950;
      border: none;
      outline: none;
      background: transparent;
      color: #0f172a;
      padding: 0;
      -webkit-appearance: none;
      appearance: textfield;
    }
    .unit{
      color: #64748b;
      font-weight: 900;
      font-size: 20px;
      white-space: nowrap;
      padding-left: 8px;
    }

    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .btn{
      border: none;
      border-radius: 18px;
      padding: 16px 14px;
      font-size: 22px;
      font-weight: 950;
      color: white;
      box-shadow: 0 16px 30px rgba(15,23,42,.18);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{ transform: scale(.985); }
    .btn.primary{
      background: linear-gradient(180deg, var(--cta1), var(--cta2));
    }
    .btn.secondary{
      background: linear-gradient(180deg, var(--ctaB1), var(--ctaB2));
    }

    .hint{
      margin-top: 10px;
      text-align:center;
      color: var(--muted);
      font-weight: 800;
    }
    .error{
      display:none;
      margin: 10px 0 0;
      padding: 10px 12px;
      background: rgba(255,235,235,.85);
      border: 1px solid rgba(255,180,180,.8);
      color:#991b1b;
      font-weight: 900;
      border-radius: 14px;
      text-align:center;
    }
    .error.show{ display:block; }

    /* ä¸‹ã®å›ºå®šãƒãƒ¼ */
    .bottomNav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px 14px 18px;
      background: rgba(255,255,255,.55);
      border-top: 1px solid rgba(255,255,255,.65);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .navInner{
      max-width: 920px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .navBtn{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.65);
      padding: 14px 10px;
      font-weight: 950;
      color: #1f2937;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .navBtn.active{
      background: rgba(210,226,255,.75);
    }
    .navBtn .navIco{ font-size: 20px; }

    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* å±¥æ­´ */
    .historyTop{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .hTitle{
      font-size: 28px;
      font-weight: 950;
      margin: 0;
    }
    .hActions{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .hBtn{
      border:none;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      box-shadow: 0 10px 18px rgba(15,23,42,.12);
    }
    .hBtn.export{ background: rgba(255,255,255,.75); }
    .hBtn.clear{ background: rgba(255,235,235,.85); color:#991b1b; }
    .list{
      display:flex; flex-direction:column; gap: 10px;
      margin-top: 10px;
    }
    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .rowLeft{
      display:flex; flex-direction:column; gap: 3px;
    }
    .rowMain{
      font-weight: 950;
      font-size: 16px;
    }
    .rowSub{
      color:#64748b;
      font-weight: 850;
      font-size: 13px;
    }
    .del{
      border:none;
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.75);
      font-weight: 950;
    }
    .empty{
      text-align:center;
      padding: 24px 12px;
      color:#64748b;
      font-weight: 900;
    }

    /* ç¶™ç¶šç”»é¢ï¼ˆDuolingoé¢¨ï¼‰ */
    .streakWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 14px;
      padding: 24px 10px;
      min-height: calc(100vh - 160px);
    }
    .flame{
      width: 120px; height: 140px;
      position: relative;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.15));
    }
    .flame .outer{
      position:absolute; inset:0;
      border-radius: 58% 42% 55% 45% / 60% 60% 40% 40%;
      background: radial-gradient(circle at 45% 60%, rgba(255,255,255,.45), rgba(255,255,255,0) 38%),
                  linear-gradient(180deg, var(--flame-outer-1), var(--flame-outer-2), var(--flame-outer-3));
      animation: flame 1.15s ease-in-out infinite;
    }
    .flame .inner{
      position:absolute;
      left: 28px; top: 34px;
      width: 64px; height: 78px;
      border-radius: 58% 42% 55% 45% / 60% 60% 40% 40%;
      background: radial-gradient(circle at 45% 60%, rgba(255,255,255,.85), rgba(255,255,255,0) 55%),
                  linear-gradient(180deg, var(--flame-inner-1), var(--flame-inner-2), var(--flame-inner-3));
      animation: flame2 1.15s ease-in-out infinite;
    }
    .flame .core{
      position:absolute;
      left: 44px; top: 56px;
      width: 32px; height: 40px;
      border-radius: 60% 40% 55% 45% / 60% 60% 40% 40%;
      background: linear-gradient(180deg, var(--flame-core-1), var(--flame-core-2));
      opacity:.95;
      animation: pulse .9s ease-in-out infinite;
    }
    @keyframes flame{
      0%,100%{ transform: translateY(0) rotate(-1.2deg) scale(1); }
      50%{ transform: translateY(-6px) rotate(1.2deg) scale(1.02); }
    }
    @keyframes flame2{
      0%,100%{ transform: translateY(0) rotate(1.0deg) scale(1); opacity:.95;}
      50%{ transform: translateY(-4px) rotate(-1.0deg) scale(1.02); opacity:1;}
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.06); }
    }

    .streakNum{
      font-size: 86px;
      font-weight: 1000;
      line-height: 1;
      margin: 0;
      background: linear-gradient(180deg, #ff9b3a, #ff4d4d);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 18px 38px rgba(255,110,60,.22);
      transform: translateY(6px);
    }
    .streakLabel{
      font-weight: 950;
      color:#ff7a45;
      letter-spacing:.02em;
      margin-top:-6px;
    }

    .streakBtns{
      width: min(520px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    /* å°ã•ã„ç«¯æœ«å¯¾ç­– */
    @media (max-width: 420px){
      .title{ font-size: 34px; }
      .menuTitle{ font-size: 38px; }
      input[type="number"]{ font-size: 38px; }
      .banner{ height: 128px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- HOME -->
    <section id="screenHome" class="screen active">
      <h1 class="title">ä»Šæ—¥ã®ä½“èª¿ã¯ï¼Ÿ</h1>

      <div class="moods" id="moodTabs">
        <button class="mood selected" data-mood="genki" type="button"><span class="ico">â˜€ï¸</span>å…ƒæ°—</button>
        <button class="mood" data-mood="futsu" type="button"><span class="ico">ğŸ’™</span>ãµã¤ã†</button>
        <button class="mood" data-mood="shindoi" type="button"><span class="ico">ğŸ™‚â€â†•ï¸</span>ã—ã‚“ã©ã„</button>
        <button class="mood" data-mood="rest" type="button"><span class="ico">ğŸ¾</span>ä¼‘æ¯</button>
      </div>

      <div class="panel">
        <div class="chip" id="moodChip"><span class="ico">â˜€ï¸</span><span>å…ƒæ°—</span></div>
        <div class="menuTitle" id="menuTitle">Fit Boxing</div>

        <div class="bannerBox">
          <img id="menuImg" class="banner" src="assets/fitboxing.png" alt="menu" />
        </div>

        <div class="inputs">
          <div class="field">
            <div class="label"><span class="miniIco">ğŸ‘Ÿ</span>ä»Šæ—¥ã®æ­©æ•°ï¼ˆç©ºæ¬„NGï¼‰</div>
            <div class="numRow">
              <input id="stepsInput" type="number" inputmode="numeric" placeholder="" />
              <span class="unit">æ­©</span>
            </div>
          </div>

          <div class="field">
            <div class="label"><span class="miniIco">ğŸ•’</span>é‹å‹•ï¼ˆç©ºæ¬„NGï¼‰</div>
            <div class="numRow">
              <input id="minsInput" type="number" inputmode="numeric" placeholder="" />
              <span class="unit">åˆ†</span>
            </div>
          </div>
        </div>

        <div id="err" class="error">æ­©æ•°ã¨åˆ†æ•°ã¯ç©ºæ¬„NGã§ã™ã€‚0ã§ã‚‚å…¥ã‚Œã¦ãã ã•ã„ã€‚</div>

        <div class="btns">
          <button class="btn primary" id="btnDone" type="button">âœ… ã‚„ã£ãŸï¼</button>
          <button class="btn secondary" id="btnMore" type="button">ï¼‹ ã‚‚ã†1ã¤ã‚„ã‚‹</button>
        </div>

        <div class="hint" id="lastLine">è¨˜éŒ²: ã¾ã ãªã—</div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="screenHistory" class="screen">
      <h1 class="title">å±¥æ­´</h1>

      <div class="panel">
        <div class="historyTop">
          <p class="hTitle">éå»ã®è¨˜éŒ²</p>
          <div class="hActions">
            <button class="hBtn export" id="btnExport" type="button">ğŸ“„ Excelç”¨ã«æ›¸ãå‡ºã—ï¼ˆCSVï¼‰</button>
            <button class="hBtn clear" id="btnClear" type="button">ğŸ—‘ å…¨æ¶ˆã—</button>
          </div>
        </div>

        <div id="historyList" class="list"></div>
      </div>
    </section>

    <!-- STREAK -->
    <section id="screenStreak" class="screen">
      <div class="streakWrap">
        <div class="flame" aria-hidden="true">
          <div class="outer"></div>
          <div class="inner"></div>
          <div class="core"></div>
        </div>

        <p class="streakNum" id="streakNum">1</p>
        <div class="streakLabel">æ—¥é€£ç¶š</div>

        <div class="streakBtns">
          <button class="btn primary" id="btnBackHome" type="button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
          <button class="btn secondary" id="btnGoHistory" type="button">å±¥æ­´ã‚’è¦‹ã‚‹</button>
        </div>
      </div>
    </section>

  </div>

  <div class="bottomNav">
    <div class="navInner">
      <button class="navBtn active" id="navHome" type="button"><span class="navIco">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
      <button class="navBtn" id="navHistory" type="button"><span class="navIco">ğŸ•˜</span>å±¥æ­´</button>
    </div>
  </div>

  <script>
    // ====== è¨­å®š ======
    const STORAGE_KEY = "workout_app_logs_v1";
    const STATE_KEY = "workout_app_state_v1";

    const MENUS = {
      genki: {
        label: "å…ƒæ°—",
        ico: "â˜€ï¸",
        // å…ƒæ°—ã ã‘ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆå†æŠ½é¸ãƒœã‚¿ãƒ³ã¯ç„¡ã—ï¼‰
        random: [
          { name: "Fit Boxing", img: "assets/fitboxing.png" },
          { name: "Ring Fit", img: "assets/ringfit.png" },
          { name: "HOP!STEP!DANCE!", img: "assets/hopstepdance.png" }
        ],
      },
      futsu: {
        label: "ãµã¤ã†",
        ico: "ğŸ’™",
        fixed: { name: "Ring Fitï¼ˆã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰ + YouTube 1æœ¬", img: "assets/ringfit.png" }
      },
      shindoi: {
        label: "ã—ã‚“ã©ã„",
        ico: "ğŸ™‚â€â†•ï¸",
        fixed: { name: "YouTube ãƒ¨ã‚¬ 1æœ¬ + å¯ã‚‹å‰ Stretch 1æœ¬", img: "assets/yoga.png" }
      },
      rest: {
        label: "ä¼‘æ¯",
        ico: "ğŸ¾",
        fixed: { name: "Rest", img: "assets/rest.png" }
      }
    };

    // ====== DOM ======
    const screenHome = document.getElementById("screenHome");
    const screenHistory = document.getElementById("screenHistory");
    const screenStreak = document.getElementById("screenStreak");

    const moodTabs = document.getElementById("moodTabs");
    const moodChip = document.getElementById("moodChip");
    const menuTitle = document.getElementById("menuTitle");
    const menuImg = document.getElementById("menuImg");
    const stepsInput = document.getElementById("stepsInput");
    const minsInput = document.getElementById("minsInput");
    const err = document.getElementById("err");
    const lastLine = document.getElementById("lastLine");

    const btnDone = document.getElementById("btnDone");
    const btnMore = document.getElementById("btnMore");

    const navHome = document.getElementById("navHome");
    const navHistory = document.getElementById("navHistory");

    const historyList = document.getElementById("historyList");
    const btnExport = document.getElementById("btnExport");
    const btnClear = document.getElementById("btnClear");

    const streakNumEl = document.getElementById("streakNum");
    const btnBackHome = document.getElementById("btnBackHome");
    const btnGoHistory = document.getElementById("btnGoHistory");

    // ====== Utility ======
    const pad = (n)=> String(n).padStart(2,"0");
    const todayKey = ()=>{
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };
    const nowTime = ()=>{
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    function loadLogs(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      }catch(e){ return []; }
    }
    function saveLogs(logs){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    }

    function loadState(){
      try{
        return JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
      }catch(e){ return {}; }
    }
    function saveState(s){
      localStorage.setItem(STATE_KEY, JSON.stringify(s));
    }

    function showScreen(name){
      screenHome.classList.remove("active");
      screenHistory.classList.remove("active");
      screenStreak.classList.remove("active");

      navHome.classList.remove("active");
      navHistory.classList.remove("active");

      if(name==="home"){
        screenHome.classList.add("active");
        navHome.classList.add("active");
      }else if(name==="history"){
        screenHistory.classList.add("active");
        navHistory.classList.add("active");
        renderHistory();
      }else if(name==="streak"){
        screenStreak.classList.add("active");
      }
      window.scrollTo({top:0, behavior:"instant"});
    }

    // ====== Menu selection ======
    function decideMenuForMood(mood){
      const st = loadState();
      const t = todayKey();

      // åŒã˜æ—¥ã«åŒã˜moodãªã‚‰ã€å…ƒæ°—ã®ãƒ©ãƒ³ãƒ€ãƒ çµæœã¯å›ºå®šï¼ˆå†æŠ½é¸ãªã—ï¼‰
      if(st.date === t && st.mood === mood && st.menuName && st.menuImg){
        return { name: st.menuName, img: st.menuImg };
      }

      const conf = MENUS[mood];
      let chosen;

      if(conf.random){
        // åˆå›ã ã‘ãƒ©ãƒ³ãƒ€ãƒ 
        chosen = conf.random[Math.floor(Math.random()*conf.random.length)];
      }else{
        chosen = conf.fixed;
      }

      saveState({
        date: t,
        mood,
        menuName: chosen.name,
        menuImg: chosen.img
      });

      return chosen;
    }

    function applyMood(mood){
      // ã‚¿ãƒ–è¦‹ãŸç›®
      [...moodTabs.querySelectorAll(".mood")].forEach(btn=>{
        btn.classList.toggle("selected", btn.dataset.mood===mood);
      });

      // ãƒãƒƒãƒ—
      const conf = MENUS[mood];
      moodChip.innerHTML = `<span class="ico">${conf.ico}</span><span>${conf.label}</span>`;

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const chosen = decideMenuForMood(mood);
      menuTitle.textContent = chosen.name;
      menuImg.src = chosen.img;

      // ã‚¨ãƒ©ãƒ¼æ¶ˆã™
      err.classList.remove("show");
    }

    // ====== Validation ======
    function isBlank(v){
      return v === null || v === undefined || String(v).trim() === "";
    }
    function validateInputs(){
      // ç©ºæ¬„NGï¼ˆ0ã¯OKã ãŒå…¥åŠ›ã¯å¿…è¦ï¼‰
      if(isBlank(stepsInput.value) || isBlank(minsInput.value)){
        err.classList.add("show");
        return false;
      }
      err.classList.remove("show");
      return true;
    }

    // ====== Logging ======
    function addLog({mood, menu, steps, mins}){
      const logs = loadLogs();
      logs.unshift({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date: todayKey(),
        time: nowTime(),
        mood,
        moodLabel: MENUS[mood].label,
        menu,
        steps: Number(steps),
        mins: Number(mins)
      });
      saveLogs(logs);
      lastLine.textContent = `è¨˜éŒ²: ${todayKey()} ${nowTime()} / ${MENUS[mood].label} / ${menu} / ${steps}æ­© / ${mins}åˆ†`;
    }

    function computeStreak(){
      const logs = loadLogs();

      // æ—¥ä»˜ã”ã¨ã«ã€Œãã®æ—¥ã«1å›ã§ã‚‚è¨˜éŒ²ãŒã‚ã‚‹ã‹ã€ã‚’ã‚»ãƒƒãƒˆåŒ–
      const days = new Set(logs.map(x => x.date));

      let streak = 0;
      let d = new Date(); // ä»Šæ—¥ã‹ã‚‰é¡ã‚‹
      while(true){
        const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        if(days.has(key)){
          streak++;
          d.setDate(d.getDate()-1);
        }else{
          break;
        }
      }
      return streak;
    }

    /* =========================================================
       ğŸ”¥ è¿½åŠ ï¼š7ã®å€æ•°ã®ã¨ãã ã‘ç‚è‰²ã‚’å¤‰ãˆã‚‹
       7æ—¥=Blue, 14æ—¥=Red, 21æ—¥=Yellow, 28æ—¥=Gold
       ä»¥é™ã¯ç¹°ã‚Šè¿”ã—ï¼ˆ35â†’Blueâ€¦ï¼‰
       â€» ãã‚Œä»¥å¤–ã®æ—¥ã¯ãƒãƒ¼ãƒãƒ«ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ã«æˆ»ã™
       ========================================================= */
    function setFlameColors(outer, inner, core){
      const r = document.documentElement.style;
      r.setProperty("--flame-outer-1", outer[0]);
      r.setProperty("--flame-outer-2", outer[1]);
      r.setProperty("--flame-outer-3", outer[2]);
      r.setProperty("--flame-inner-1", inner[0]);
      r.setProperty("--flame-inner-2", inner[1]);
      r.setProperty("--flame-inner-3", inner[2]);
      r.setProperty("--flame-core-1", core[0]);
      r.setProperty("--flame-core-2", core[1]);
    }

    function applyFlameThemeForStreak(streak){
      // ãƒãƒ¼ãƒãƒ«ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
      const NORMAL = {
        outer:["#ffd66b","#ff8a2f","#ff4d4d"],
        inner:["#fff2b0","#ffd06a","#ff7a3a"],
        core:["#ffffff","#fff1c6"]
      };

      // 7ã®å€æ•°ä»¥å¤–ã¯ãƒãƒ¼ãƒãƒ«
      if(!streak || streak % 7 !== 0){
        setFlameColors(NORMAL.outer, NORMAL.inner, NORMAL.core);
        return;
      }

      // 7,14,21,28... ã‚’ 0..3 ã«å›ã™ï¼ˆç¹°ã‚Šè¿”ã—ï¼‰
      const idx = (Math.floor(streak / 7) - 1) % 4;

      const THEMES = [
        // 7æ—¥ï¼šBlue
        {
          outer:["#bfe7ff","#4aa3ff","#2f6bff"],
          inner:["#e8f6ff","#9ad6ff","#4aa3ff"],
          core:["#ffffff","#d7eeff"]
        },
        // 14æ—¥ï¼šRedï¼ˆãƒãƒ¼ãƒãƒ«ã‚ˆã‚Šâ€œèµ¤å¯„ã‚Šâ€ã«ï¼‰
        {
          outer:["#ffb3b3","#ff5a5a","#ff2d2d"],
          inner:["#ffe0e0","#ff9a9a","#ff5a5a"],
          core:["#ffffff","#ffe6e6"]
        },
        // 21æ—¥ï¼šYellow
        {
          outer:["#fff5b3","#ffd76a","#ffb800"],
          inner:["#fff9cf","#ffe59a","#ffd76a"],
          core:["#ffffff","#fff6d2"]
        },
        // 28æ—¥ï¼šGoldï¼ˆã‚ˆã‚Šã”è¤’ç¾æ„Ÿï¼‰
        {
          outer:["#fff2b0","#ffd24a","#ff9f1a"],
          inner:["#fff9d6","#ffe08a","#ffd24a"],
          core:["#ffffff","#fff3c4"]
        }
      ];

      const t = THEMES[idx];
      setFlameColors(t.outer, t.inner, t.core);
    }

    // ====== History ======
    function renderHistory(){
      const logs = loadLogs();
      historyList.innerHTML = "";

      if(!logs.length){
        historyList.innerHTML = `<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
        return;
      }

      logs.forEach(item=>{
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "rowLeft";
        left.innerHTML = `
          <div class="rowMain">${item.date} ${item.time} / ${item.moodLabel}</div>
          <div class="rowSub">${item.menu}ã€€ãƒ»ã€€${item.steps}æ­©ã€€ãƒ»ã€€${item.mins}åˆ†</div>
        `;

        const del = document.createElement("button");
        del.className = "del";
        del.type = "button";
        del.textContent = "æ¶ˆã™";
        del.onclick = ()=>{
          const next = loadLogs().filter(x=>x.id!==item.id);
          saveLogs(next);
          renderHistory();
        };

        row.appendChild(left);
        row.appendChild(del);
        historyList.appendChild(row);
      });
    }

    // CSV exportï¼ˆExcelã§é–‹ã‘ã‚‹ï¼‰
    function exportCSV(){
      const logs = loadLogs();
      if(!logs.length){
        alert("å±¥æ­´ãŒç©ºã§ã™");
        return;
      }
      const header = ["date","time","mood","menu","steps","mins"];
      const lines = [header.join(",")];

      logs.slice().reverse().forEach(x=>{
        const esc = (s)=> `"${String(s).replaceAll('"','""')}"`;
        lines.push([
          esc(x.date),
          esc(x.time),
          esc(x.moodLabel),
          esc(x.menu),
          x.steps,
          x.mins
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `workout_log_${todayKey()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== Events ======
    moodTabs.addEventListener("click", (e)=>{
      const btn = e.target.closest(".mood");
      if(!btn) return;
      const mood = btn.dataset.mood;
      applyMood(mood);
    });

    btnDone.addEventListener("click", ()=>{
      if(!validateInputs()) return;

      const st = loadState();
      const mood = st.mood || "genki";
      const menu = st.menuName || menuTitle.textContent;

      addLog({
        mood,
        menu,
        steps: stepsInput.value,
        mins: minsInput.value
      });

      // ç¶™ç¶šæ—¥æ•°è¨ˆç®—ã—ã¦è¡¨ç¤ºï¼ˆä¼‘æ¯ã‚‚å«ã¾ã‚Œã‚‹ï¼šãƒ­ã‚°ãŒã‚ã‚Œã°OKï¼‰
      const streak = computeStreak();
      streakNumEl.textContent = streak;

      // ğŸ”¥ è¿½åŠ ï¼š7ã®å€æ•°ã ã‘è‰²å¤‰æ›´
      applyFlameThemeForStreak(streak);

      // å…¥åŠ›ã¯æ®‹ã—ã¦OKï¼ˆè§¦ã‚ŠãŸã„ã¨ã®ã“ã¨ãªã®ã§ï¼‰ã€ã§ã‚‚æ¬¡ã®å…¥åŠ›ãŒã—ã‚„ã™ã„ã‚ˆã†ã«ä»»æ„ã§é¸æŠçŠ¶æ…‹ã«
      stepsInput.select?.();
      showScreen("streak");
    });

    btnMore.addEventListener("click", ()=>{
      // ã‚‚ã†1ã¤ã‚„ã‚‹ï¼šç¶™ç¶šç”»é¢ã«è¡Œã‹ãšã€ãã®ã¾ã¾è¨˜éŒ²ã‚’è¶³ã—ã¦ãƒ›ãƒ¼ãƒ ã«æ®‹ã‚‹
      if(!validateInputs()) return;

      const st = loadState();
      const mood = st.mood || "genki";
      const menu = st.menuName || menuTitle.textContent;

      addLog({
        mood,
        menu,
        steps: stepsInput.value,
        mins: minsInput.value
      });

      // å…¥åŠ›ã‚’ã™ãæ¬¡ã«æ‰“ã¦ã‚‹ã‚ˆã†ã«å°‘ã—æ•´ãˆã‚‹ï¼ˆ0å›ºå®šã§ã¯ãªãã€ç©ºã«ã—ã¦ã€Œç©ºæ¬„NGã€ãªã®ã§å¿…ãšå…¥åŠ›ï¼‰
      stepsInput.value = "";
      minsInput.value = "";
      err.classList.remove("show");
      stepsInput.focus();

      // ã¡ã‚‡ã„é€šçŸ¥
      lastLine.textContent = `è¨˜éŒ²: ${todayKey()} ${nowTime()} / è¿½åŠ ã§è¨˜éŒ²ã—ãŸã‚ˆ`;
    });

    navHome.addEventListener("click", ()=> showScreen("home"));
    navHistory.addEventListener("click", ()=> showScreen("history"));

    btnBackHome.addEventListener("click", ()=> showScreen("home"));
    btnGoHistory.addEventListener("click", ()=> showScreen("history"));

    btnExport.addEventListener("click", exportCSV);

    btnClear.addEventListener("click", ()=>{
      if(confirm("å±¥æ­´ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ")){
        localStorage.removeItem(STORAGE_KEY);
        renderHistory();
      }
    });

    // ====== Init ======
    (function init(){
      // åˆæœŸçŠ¶æ…‹ï¼šå…ƒæ°—
      const st = loadState();
      const mood = st.mood || "genki";
      applyMood(mood);

      // æœ€çµ‚ãƒ­ã‚°è¡¨ç¤º
      const logs = loadLogs();
      if(logs.length){
        const x = logs[0];
        lastLine.textContent = `è¨˜éŒ²: ${x.date} ${x.time} / ${x.moodLabel} / ${x.menu} / ${x.steps}æ­© / ${x.mins}åˆ†`;
      }else{
        lastLine.textContent = "è¨˜éŒ²: ã¾ã ãªã—";
      }

      // ğŸ”¥ è¿½åŠ ï¼šãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ç‚¹ã§ã‚‚ã€Œç¾åœ¨ã®ç¶™ç¶šæ—¥æ•°ã€ã«å¿œã˜ã¦ç‚è‰²ã‚’æ•´ãˆã‚‹
      // ï¼ˆ7ã®å€æ•°ä»¥å¤–ã¯ãƒãƒ¼ãƒãƒ«ã«æˆ»ã‚‹ï¼‰
      applyFlameThemeForStreak(computeStreak());
    })();
  </script>
</body>
</html>