<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Workout Mood</title>

  <style>
    :root{
      --ink:#1f2937;
      --muted:#6b7280;
      --card:rgba(255,255,255,.78);
      --shadow: 0 16px 40px rgba(15,23,42,.12);
      --shadow2: 0 10px 24px rgba(15,23,42,.10);
      --radius: 26px;

      --cta1:#ffb45a; --cta2:#ff7a45;
      --ctaB1:#6aa9ff;--ctaB2:#2f6bff;

      /* ç‚ãƒ†ãƒ¼ãƒï¼ˆé€šå¸¸ï¼‰ */
      --flameA:#ffd66b;
      --flameB:#ff8a2f;
      --flameC:#ff4d4d;
      --flameInnerA:#fff2b0;
      --flameInnerB:#ffd06a;
      --flameInnerC:#ff7a3a;
      --flameGlow: rgba(255,140,60,.35);
      --flameNumA:#ff9b3a;
      --flameNumB:#ff4d4d;
      --flameLabel:#ff7a45;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color:var(--ink);
      min-height:100vh;
      background:#eef4ff;

      /* âœ… iPhoneã§æ‹¡å¤§ã‚ºãƒ¬ã—ãŒã¡ãª fixed ã‚’ä½¿ã‚ãªã„ */
      background-image: url("assets/background.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center top;
      background-attachment: scroll;
    }

    /* âœ¨ ãµã‚ã‚­ãƒ©ï¼ˆä¸è¦ãªã‚‰ opacity:0 ã®ã¾ã¾ï¼‰ */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(1.2px 1.2px at 12% 18%, rgba(255,255,255,.9), rgba(255,255,255,0) 60%),
        radial-gradient(1.6px 1.6px at 28% 32%, rgba(255,255,255,.75), rgba(255,255,255,0) 62%),
        radial-gradient(1.1px 1.1px at 63% 14%, rgba(255,255,255,.85), rgba(255,255,255,0) 60%),
        radial-gradient(1.7px 1.7px at 74% 36%, rgba(255,255,255,.65), rgba(255,255,255,0) 62%),
        radial-gradient(1.3px 1.3px at 84% 22%, rgba(255,255,255,.8), rgba(255,255,255,0) 60%),
        radial-gradient(1.2px 1.2px at 18% 72%, rgba(255,255,255,.7), rgba(255,255,255,0) 62%),
        radial-gradient(1.7px 1.7px at 52% 76%, rgba(255,255,255,.65), rgba(255,255,255,0) 62%),
        radial-gradient(1.2px 1.2px at 86% 78%, rgba(255,255,255,.7), rgba(255,255,255,0) 62%);
      opacity:0;
      filter: blur(.2px);
      animation: twinkle 6s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%,100%{opacity:.45; transform:translateY(0)}
      50%{opacity:.70; transform:translateY(-6px)}
    }

    .app{
      max-width: 920px;
      margin: 0 auto;
      padding: 22px 16px 110px;
    }

    .title{
      text-align:center;
      font-size: 40px;
      letter-spacing: .02em;
      margin: 10px 0 14px;
      text-shadow: 0 6px 18px rgba(15,23,42,.12);
    }

    /* ä¸Šã®ä½“èª¿ã‚¿ãƒ– */
    .moods{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 12px auto 16px;
    }
    .mood{
      user-select:none;
      border: 1px solid rgba(255,255,255,.6);
      background: rgba(255,255,255,.70);
      box-shadow: var(--shadow2);
      border-radius: 18px;
      padding: 12px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight: 800;
      color:#1f2937;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .mood:active{ transform: scale(.98); }
    .mood .ico{ font-size: 18px; opacity:.9 }
    .mood.selected{
      color:#111827;
      border-color: rgba(255,255,255,.75);
    }
    .mood[data-mood="genki"].selected{
      background: linear-gradient(180deg, rgba(255,215,106,.85), rgba(255,184,0,.75));
    }
    .mood[data-mood="futsu"].selected{
      background: linear-gradient(180deg, rgba(191,241,230,.85), rgba(43,212,189,.70));
    }
    .mood[data-mood="shindoi"].selected{
      background: linear-gradient(180deg, rgba(203,188,255,.85), rgba(124,92,255,.65));
      color:#0f172a;
    }
    .mood[data-mood="rest"].selected{
      background: linear-gradient(180deg, rgba(217,223,232,.85), rgba(154,167,184,.60));
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .panel{
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.60);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight: 900;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.65);
      box-shadow: 0 8px 18px rgba(15,23,42,.10);
      margin: 6px 0 8px;
    }
    .chip .ico{font-size:16px}

    /* âœ… ã‚¿ã‚¤ãƒˆãƒ«ã¯é•·ã„æ™‚ã«è‡ªå‹•ç¸®å°ï¼ˆJSï¼‰ï¼‹æŠ˜è¿”ã—ã‚‚è¨±å¯ */
    .menuTitle{
      font-size: 44px; /* JSã§èª¿æ•´ */
      font-weight: 950;
      margin: 6px 0 10px;
      line-height: 1.08;
      letter-spacing: .01em;
      text-shadow: 0 8px 22px rgba(15,23,42,.12);
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .bannerBox{
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.65);
      border-radius: 20px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .banner{
      width: 100%;
      height: 140px;
      object-fit: cover;
      object-position: center;
      display:block;
      background: rgba(255,255,255,.10);
    }

    .inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .field{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(255,255,255,.65);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
      overflow:hidden;
    }

    .label{
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-weight: 900;
      color: #334155;
      margin-bottom: 10px;
    }
    .label .miniIco{ font-size: 18px; opacity:.9; line-height:1.2; margin-top:1px; }

    .labelText{
      display:flex;
      flex-direction:column;
      line-height: 1.05;
    }
    .labelMain{ font-weight: 950; }
    .labelSub{
      font-weight: 900;
      color:#64748b;
      font-size: 13px;
      margin-top: 4px;
    }

    /* âœ… 5æ¡ã§ã‚‚å…¥ã‚‹åœŸå° */
    .numRow{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
    }
    input[type="number"]{
      flex: 1;
      min-width: 0;
      width: 100%;
      font-size: 42px; /* JSã§èª¿æ•´ */
      font-weight: 950;
      border: none;
      outline: none;
      background: transparent;
      color: #0f172a;
      padding: 0;
      -webkit-appearance: none;
      appearance: textfield;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.01em;
    }
    .unit{
      color: #64748b;
      font-weight: 900;
      font-size: 18px;
      white-space: nowrap;
      padding-left: 4px;
      flex: 0 0 auto;
    }

    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .btn{
      border: none;
      border-radius: 18px;
      padding: 16px 14px;
      font-size: 22px;
      font-weight: 950;
      color: white;
      box-shadow: 0 16px 30px rgba(15,23,42,.18);
      transition: transform .12s ease;
    }
    .btn:active{ transform: scale(.985); }
    .btn.primary{ background: linear-gradient(180deg, var(--cta1), var(--cta2)); }
    .btn.secondary{ background: linear-gradient(180deg, var(--ctaB1), var(--ctaB2)); }

    .hint{
      margin-top: 10px;
      text-align:center;
      color: var(--muted);
      font-weight: 800;
      word-break: break-word;
    }
    .error{
      display:none;
      margin: 10px 0 0;
      padding: 10px 12px;
      background: rgba(255,235,235,.85);
      border: 1px solid rgba(255,180,180,.8);
      color:#991b1b;
      font-weight: 900;
      border-radius: 14px;
      text-align:center;
    }
    .error.show{ display:block; }

    /* ä¸‹ã®å›ºå®šãƒãƒ¼ */
    .bottomNav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px 14px 18px;
      background: rgba(255,255,255,.55);
      border-top: 1px solid rgba(255,255,255,.65);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .navInner{
      max-width: 920px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .navBtn{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.65);
      padding: 14px 10px;
      font-weight: 950;
      color: #1f2937;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .navBtn.active{ background: rgba(210,226,255,.75); }
    .navBtn .navIco{ font-size: 20px; }

    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* å±¥æ­´ */
    .historyTop{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .hTitle{
      font-size: 28px;
      font-weight: 950;
      margin: 0;
    }
    .hActions{ display:flex; gap:10px; flex-wrap:wrap; }
    .hBtn{
      border:none;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      box-shadow: 0 10px 18px rgba(15,23,42,.12);
    }
    .hBtn.export{ background: rgba(255,255,255,.75); }
    .hBtn.clear{ background: rgba(255,235,235,.85); color:#991b1b; }
    .list{ display:flex; flex-direction:column; gap: 10px; margin-top: 10px; }
    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .rowLeft{ display:flex; flex-direction:column; gap: 3px; }
    .rowMain{ font-weight: 950; font-size: 16px; }
    .rowSub{ color:#64748b; font-weight: 850; font-size: 13px; }
    .del{
      border:none;
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.75);
      font-weight: 950;
    }
    .empty{
      text-align:center;
      padding: 24px 12px;
      color:#64748b;
      font-weight: 900;
    }

    /* âœ… éå»åˆ†è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰ */
    .pastAdder{ margin: 6px 0 8px; }
    .pastForm{
      margin-top: 10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.60);
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
      display: none;
    }
    .pastForm.show{ display:block; }

    .pastGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pastSpan2{ grid-column: 1 / -1; }

    .pastField{ display:flex; flex-direction:column; gap: 6px; }
    .pastLabel{
      font-weight: 900;
      color:#334155;
      font-size: 13px;
    }
    .pastField input,
    .pastField select{
      border: 1px solid rgba(255,255,255,.75);
      background: rgba(255,255,255,.75);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      color:#0f172a;
      outline: none;
    }
    .pastActions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    /* ç¶™ç¶šç”»é¢ */
    .streakWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 14px;
      padding: 24px 10px;
      min-height: calc(100vh - 160px);
    }

    .flame{
      width: 120px;
      height: 160px;
      position: relative;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.15));
      transform-origin: 50% 80%;
    }
    .flame .outer{
      position:absolute; inset:0;
      border-radius: 58% 42% 72% 28% / 70% 70% 30% 30%;
      background:
        radial-gradient(circle at 45% 68%, rgba(255,255,255,.28), rgba(255,255,255,0) 42%),
        linear-gradient(180deg, var(--flameA), var(--flameB), var(--flameC));
      animation: flameOuter 1.15s ease-in-out infinite;
      will-change: transform;
    }
    .flame .inner{
      position:absolute;
      left: 26px; top: 36px;
      width: 70px; height: 92px;
      border-radius: 62% 38% 70% 30% / 72% 68% 32% 28%;
      background:
        radial-gradient(circle at 50% 70%, rgba(255,255,255,.60), rgba(255,255,255,0) 56%),
        linear-gradient(180deg, var(--flameInnerA), var(--flameInnerB), var(--flameInnerC));
      animation: flameInner 1.15s ease-in-out infinite;
      will-change: transform;
    }
    .flame .core{
      position:absolute;
      left: 46px; top: 64px;
      width: 32px; height: 44px;
      border-radius: 60% 40% 68% 32% / 70% 70% 30% 30%;
      background: linear-gradient(180deg, #ffffff, #fff1c6);
      opacity:.96;
      animation: flameCore .95s ease-in-out infinite;
      will-change: transform;
    }
    @keyframes flameOuter{
      0%,100%{ transform: translateY(0) rotate(-6deg) scale(1); }
      50%{    transform: translateY(-8px) rotate(-4deg) scale(1.035); }
    }
    @keyframes flameInner{
      0%,100%{ transform: translateY(0) rotate(5deg) scale(1); opacity:.95; }
      50%{    transform: translateY(-6px) rotate(3deg) scale(1.04); opacity:1; }
    }
    @keyframes flameCore{
      0%,100%{ transform: scale(1); }
      50%{    transform: scale(1.10); }
    }

    .flame.is-ignite .outer,
    .flame.is-ignite .inner,
    .flame.is-ignite .core{
      animation: ignitePop 900ms cubic-bezier(.2,.95,.2,1) both;
    }
    .flame.is-ignite .outer{
      box-shadow: 0 0 72px var(--flameGlow);
    }
    @keyframes ignitePop{
      0%   { transform: translateY(18px) scale(.80); filter: blur(2px); opacity:0; }
      35%  { transform: translateY(-26px) scale(1.16); filter: blur(0px); opacity:1; }
      65%  { transform: translateY(8px)  scale(.98); }
      100% { transform: translateY(0)    scale(1); }
    }

    .streakNum{
      font-size: 86px;
      font-weight: 1000;
      line-height: 1;
      margin: 0;
      background: linear-gradient(180deg, var(--flameNumA), var(--flameNumB));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 18px 38px rgba(255,110,60,.22);
      transform: translateY(6px);
    }
    .streakLabel{
      font-weight: 950;
      color: var(--flameLabel);
      letter-spacing:.02em;
      margin-top:-6px;
    }
    .streakBtns{
      width: min(520px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 420px){
      .title{ font-size: 34px; }
      .banner{ height: 128px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- HOME -->
    <section id="screenHome" class="screen active">
      <h1 class="title">ä»Šæ—¥ã®ä½“èª¿ã¯ï¼Ÿ</h1>

      <div class="moods" id="moodTabs">
        <button class="mood selected" data-mood="genki" type="button"><span class="ico">â˜€ï¸</span>å…ƒæ°—</button>
        <button class="mood" data-mood="futsu" type="button"><span class="ico">ğŸ’™</span>ãµã¤ã†</button>
        <button class="mood" data-mood="shindoi" type="button"><span class="ico">ğŸ™‚â€â†•ï¸</span>ã—ã‚“ã©ã„</button>
        <button class="mood" data-mood="rest" type="button"><span class="ico">ğŸ¾</span>ä¼‘æ¯</button>
      </div>

      <div class="panel">
        <div class="chip" id="moodChip"><span class="ico">â˜€ï¸</span><span>å…ƒæ°—</span></div>
        <div class="menuTitle" id="menuTitle">Fit Boxing</div>

        <div class="bannerBox">
          <img id="menuImg" class="banner" src="assets/fitboxing.png" alt="menu" />
        </div>

        <div class="inputs">
          <div class="field">
            <div class="label">
              <span class="miniIco">ğŸ‘Ÿ</span>
              <span class="labelText">
                <span class="labelMain">ä»Šæ—¥ã®æ­©æ•°</span>
                <span class="labelSub">ï¼ˆç©ºæ¬„NGï¼‰</span>
              </span>
            </div>
            <div class="numRow">
              <input id="stepsInput" type="number" inputmode="numeric" placeholder="" />
              <span class="unit">æ­©</span>
            </div>
          </div>

          <div class="field">
            <div class="label">
              <span class="miniIco">ğŸ•’</span>
              <span class="labelText">
                <span class="labelMain">é‹å‹•</span>
                <span class="labelSub">ï¼ˆç©ºæ¬„NGï¼‰</span>
              </span>
            </div>
            <div class="numRow">
              <input id="minsInput" type="number" inputmode="numeric" placeholder="" />
              <span class="unit">åˆ†</span>
            </div>
          </div>
        </div>

        <div id="err" class="error">æ­©æ•°ã¨åˆ†æ•°ã¯ç©ºæ¬„NGã§ã™ã€‚0ã§ã‚‚å…¥ã‚Œã¦ãã ã•ã„ã€‚</div>

        <div class="btns">
          <button class="btn primary" id="btnDone" type="button">âœ… ã‚„ã£ãŸï¼</button>
          <button class="btn secondary" id="btnMore" type="button">ï¼‹ ã‚‚ã†1ã¤ã‚„ã‚‹</button>
        </div>

        <div class="hint" id="lastLine">è¨˜éŒ²: ã¾ã ãªã—</div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="screenHistory" class="screen">
      <h1 class="title">å±¥æ­´</h1>

      <div class="panel">
        <div class="historyTop">
          <p class="hTitle">éå»ã®è¨˜éŒ²</p>
          <div class="hActions">
            <button class="hBtn export" id="btnExport" type="button">ğŸ“„ Excelç”¨ã«æ›¸ãå‡ºã—ï¼ˆCSVï¼‰</button>
            <button class="hBtn clear" id="btnClear" type="button">ğŸ—‘ å…¨æ¶ˆã—</button>
          </div>
        </div>

        <!-- âœ… éå»åˆ†å…¥åŠ›ï¼ˆãƒœã‚¿ãƒ³â†’ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼‰ -->
        <div class="pastAdder">
          <button class="hBtn export" id="btnAddPast" type="button">ï¼‹ éå»åˆ†ã‚’è¿½åŠ </button>

          <div class="pastForm" id="pastForm" aria-hidden="true">
            <div class="pastGrid">
              <label class="pastField">
                <span class="pastLabel">æ—¥ä»˜</span>
                <input id="pastDate" type="date" />
              </label>

              <label class="pastField">
                <span class="pastLabel">ä½“èª¿</span>
                <select id="pastMood">
                  <option value="genki">å…ƒæ°—</option>
                  <option value="futsu">ãµã¤ã†</option>
                  <option value="shindoi">ã—ã‚“ã©ã„</option>
                  <option value="rest">ä¼‘æ¯</option>
                </select>
              </label>

              <label class="pastField pastSpan2">
                <span class="pastLabel">é‹å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆä»»æ„ï¼‰</span>
                <input id="pastMenu" type="text" placeholder="ä¾‹ï¼šFit Boxing" />
              </label>

              <label class="pastField">
                <span class="pastLabel">æ­©æ•°</span>
                <input id="pastSteps" type="number" inputmode="numeric" placeholder="0ã§ã‚‚OK" />
              </label>

              <label class="pastField">
                <span class="pastLabel">é‹å‹•ï¼ˆåˆ†ï¼‰</span>
                <input id="pastMins" type="number" inputmode="numeric" placeholder="0ã§ã‚‚OK" />
              </label>
            </div>

            <div class="pastActions">
              <button class="hBtn export" id="btnPastSave" type="button">è¿½åŠ </button>
              <button class="hBtn clear" id="btnPastCancel" type="button">é–‰ã˜ã‚‹</button>
            </div>

            <div class="error" id="pastErr">æ—¥ä»˜ãƒ»æ­©æ•°ãƒ»åˆ†ã¯ç©ºæ¬„NGã§ã™ï¼ˆ0ã§ã‚‚OKï¼‰ã€‚</div>
          </div>
        </div>

        <div id="historyList" class="list"></div>
      </div>
    </section>

    <!-- STREAK -->
    <section id="screenStreak" class="screen">
      <div class="streakWrap">
        <div class="flame" id="flame" aria-hidden="true">
          <div class="outer"></div>
          <div class="inner"></div>
          <div class="core"></div>
        </div>

        <p class="streakNum" id="streakNum">1</p>
        <div class="streakLabel">æ—¥é€£ç¶š</div>

        <div class="streakBtns">
          <button class="btn primary" id="btnBackHome" type="button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
          <button class="btn secondary" id="btnGoHistory" type="button">å±¥æ­´ã‚’è¦‹ã‚‹</button>
        </div>
      </div>
    </section>

  </div>

  <div class="bottomNav">
    <div class="navInner">
      <button class="navBtn active" id="navHome" type="button"><span class="navIco">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
      <button class="navBtn" id="navHistory" type="button"><span class="navIco">ğŸ•˜</span>å±¥æ­´</button>
    </div>
  </div>

  <script>
    // ====== è¨­å®š ======
    const STORAGE_KEY = "workout_app_logs_v1";
    const STATE_KEY = "workout_app_state_v1";

    const MENUS = {
      genki: {
        label: "å…ƒæ°—",
        ico: "â˜€ï¸",
        random: [
          { name: "Fit Boxing", img: "assets/fitboxing.png" },
          { name: "Ring Fit", img: "assets/ringfit.png" },
          { name: "HOP!STEP!DANCE!", img: "assets/hopstepdance.png" }
        ],
      },
      futsu: { label: "ãµã¤ã†", ico: "ğŸ’™", fixed: { name: "Fit Boxing", img: "assets/fitboxing.png" } },
      shindoi:{ label: "ã—ã‚“ã©ã„", ico: "ğŸ™‚â€â†•ï¸", fixed: { name: "YOGA", img: "assets/yoga.png" } },
      rest:   { label: "ä¼‘æ¯", ico: "ğŸ¾", fixed: { name: "Rest", img: "assets/rest.png" } }
    };

    // ====== DOM ======
    const screenHome = document.getElementById("screenHome");
    const screenHistory = document.getElementById("screenHistory");
    const screenStreak = document.getElementById("screenStreak");

    const moodTabs = document.getElementById("moodTabs");
    const moodChip = document.getElementById("moodChip");
    const menuTitle = document.getElementById("menuTitle");
    const menuImg = document.getElementById("menuImg");
    const stepsInput = document.getElementById("stepsInput");
    const minsInput = document.getElementById("minsInput");
    const err = document.getElementById("err");
    const lastLine = document.getElementById("lastLine");

    const btnDone = document.getElementById("btnDone");
    const btnMore = document.getElementById("btnMore");

    const navHome = document.getElementById("navHome");
    const navHistory = document.getElementById("navHistory");

    const historyList = document.getElementById("historyList");
    const btnExport = document.getElementById("btnExport");
    const btnClear = document.getElementById("btnClear");

    const streakNumEl = document.getElementById("streakNum");
    const btnBackHome = document.getElementById("btnBackHome");
    const btnGoHistory = document.getElementById("btnGoHistory");

    // âœ… éå»åˆ†è¿½åŠ DOM
    const btnAddPast = document.getElementById("btnAddPast");
    const pastForm = document.getElementById("pastForm");
    const pastDate = document.getElementById("pastDate");
    const pastMood = document.getElementById("pastMood");
    const pastMenu = document.getElementById("pastMenu");
    const pastSteps = document.getElementById("pastSteps");
    const pastMins = document.getElementById("pastMins");
    const btnPastSave = document.getElementById("btnPastSave");
    const btnPastCancel = document.getElementById("btnPastCancel");
    const pastErr = document.getElementById("pastErr");

    // ====== Utility ======
    const pad = (n)=> String(n).padStart(2,"0");
    const todayKey = ()=>{
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };
    const nowTime = ()=>{
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    function loadLogs(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch(e){ return []; }
    }
    function saveLogs(logs){ localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); }

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(STATE_KEY) || "{}"); }
      catch(e){ return {}; }
    }
    function saveState(s){ localStorage.setItem(STATE_KEY, JSON.stringify(s)); }

    function isBlank(v){ return v === null || v === undefined || String(v).trim() === ""; }

    // âœ… æ—¥ä»˜/æ™‚é–“ã§ä¸¦ã³æ›¿ãˆï¼ˆæ–°ã—ã„é †ï¼‰
    function sortLogsByDateTimeDesc(logs){
      return logs.sort((a,b)=>{
        const ka = `${a.date} ${a.time}`;
        const kb = `${b.date} ${b.time}`;
        return kb.localeCompare(ka);
      });
    }

    // ====== âœ… ãƒ•ã‚£ãƒƒãƒˆç³»ï¼ˆã‚¿ã‚¤ãƒˆãƒ« / æ•°å­—ï¼‰ ======

    // ã‚¿ã‚¤ãƒˆãƒ«ï¼šè¦ªå¹…ã«åã¾ã‚‹ã¾ã§ç¸®ã‚ã‚‹ï¼ˆmeasureæ–¹å¼ï¼‰
    function fitMenuTitle(){
      if(!menuTitle) return;
      const parent = menuTitle.parentElement;
      if(!parent) return;

      const measure = document.createElement("span");
      const cs = getComputedStyle(menuTitle);
      measure.style.position = "absolute";
      measure.style.visibility = "hidden";
      measure.style.whiteSpace = "pre";
      measure.style.fontFamily = cs.fontFamily;
      measure.style.fontWeight = cs.fontWeight;
      measure.style.letterSpacing = cs.letterSpacing;
      document.body.appendChild(measure);

      const text = menuTitle.textContent || "";
      const maxPx = 44, minPx = 20;
      let size = maxPx;

      const available = parent.getBoundingClientRect().width;

      while(size > minPx){
        measure.style.fontSize = size + "px";
        measure.textContent = text;
        if(measure.getBoundingClientRect().width <= available) break;
        size -= 1;
      }
      menuTitle.style.fontSize = size + "px";
      measure.remove();
    }

    // å…¥åŠ›ï¼š5æ¡ã§ã‚‚åã¾ã‚‹ã¾ã§ç¸®ã‚ã‚‹ï¼ˆå˜ä½ã¶ã‚“ã®å¹…ã‚’å¼•ãï¼‰
    function fitNumberInput(input){
      const wrap = input.parentElement;
      if(!wrap) return;

      const measure = document.createElement("span");
      const cs = getComputedStyle(input);
      measure.style.position = "absolute";
      measure.style.visibility = "hidden";
      measure.style.whiteSpace = "pre";
      measure.style.fontFamily = cs.fontFamily;
      measure.style.fontWeight = cs.fontWeight;
      measure.style.letterSpacing = cs.letterSpacing;
      measure.style.fontVariantNumeric = cs.fontVariantNumeric;
      document.body.appendChild(measure);

      const maxPx = 42, minPx = 26;
      let size = maxPx;

      const unit = wrap.querySelector(".unit");
      const unitW = unit ? unit.getBoundingClientRect().width : 0;
      const wrapW = wrap.getBoundingClientRect().width;
      const available = Math.max(0, wrapW - unitW - 10);

      const text = (input.value ?? "").toString();
      const sample = text.length ? text : "0";

      while(size > minPx){
        measure.style.fontSize = size + "px";
        measure.textContent = sample;
        if(measure.getBoundingClientRect().width <= available) break;
        size -= 1;
      }
      input.style.fontSize = size + "px";
      measure.remove();
    }

    function refitAll(){
      fitMenuTitle();
      fitNumberInput(stepsInput);
      fitNumberInput(minsInput);
    }

    // ====== Flame theme (7ã®å€æ•°ã ã‘è‰²ãƒã‚§ãƒ³ã‚¸) ======
    function setFlameThemeForStreak(streak){
      const root = document.documentElement.style;
      const isMultiple7 = streak > 0 && (streak % 7 === 0);

      if(!isMultiple7){
        root.setProperty("--flameA", "#ffd66b");
        root.setProperty("--flameB", "#ff8a2f");
        root.setProperty("--flameC", "#ff4d4d");
        root.setProperty("--flameInnerA", "#fff2b0");
        root.setProperty("--flameInnerB", "#ffd06a");
        root.setProperty("--flameInnerC", "#ff7a3a");
        root.setProperty("--flameGlow", "rgba(255,140,60,.35)");
        root.setProperty("--flameNumA", "#ff9b3a");
        root.setProperty("--flameNumB", "#ff4d4d");
        root.setProperty("--flameLabel", "#ff7a45");
        return;
      }

      const phase = (Math.floor(streak / 7) - 1) % 4;
      if(phase === 0){
        root.setProperty("--flameA", "#b8e7ff");
        root.setProperty("--flameB", "#3aa7ff");
        root.setProperty("--flameC", "#2f6bff");
        root.setProperty("--flameInnerA", "#e8f7ff");
        root.setProperty("--flameInnerB", "#9edcff");
        root.setProperty("--flameInnerC", "#3aa7ff");
        root.setProperty("--flameGlow", "rgba(58,167,255,.40)");
        root.setProperty("--flameNumA", "#3aa7ff");
        root.setProperty("--flameNumB", "#2f6bff");
        root.setProperty("--flameLabel", "#2f6bff");
      }else if(phase === 1){
        root.setProperty("--flameA", "#ffd1d1");
        root.setProperty("--flameB", "#ff4d4d");
        root.setProperty("--flameC", "#d81b60");
        root.setProperty("--flameInnerA", "#ffecec");
        root.setProperty("--flameInnerB", "#ff9a9a");
        root.setProperty("--flameInnerC", "#ff4d4d");
        root.setProperty("--flameGlow", "rgba(255,77,77,.40)");
        root.setProperty("--flameNumA", "#ff4d4d");
        root.setProperty("--flameNumB", "#d81b60");
        root.setProperty("--flameLabel", "#d81b60");
      }else if(phase === 2){
        root.setProperty("--flameA", "#fff7b3");
        root.setProperty("--flameB", "#ffd400");
        root.setProperty("--flameC", "#ff9b3a");
        root.setProperty("--flameInnerA", "#fffbe0");
        root.setProperty("--flameInnerB", "#ffe27a");
        root.setProperty("--flameInnerC", "#ffd400");
        root.setProperty("--flameGlow", "rgba(255,212,0,.40)");
        root.setProperty("--flameNumA", "#ffd400");
        root.setProperty("--flameNumB", "#ff9b3a");
        root.setProperty("--flameLabel", "#c28b00");
      }else{
        root.setProperty("--flameA", "#fff1a6");
        root.setProperty("--flameB", "#ffcf4a");
        root.setProperty("--flameC", "#ff8a2f");
        root.setProperty("--flameInnerA", "#fff7cc");
        root.setProperty("--flameInnerB", "#ffe27a");
        root.setProperty("--flameInnerC", "#ffcf4a");
        root.setProperty("--flameGlow", "rgba(255,207,74,.42)");
        root.setProperty("--flameNumA", "#ffcf4a");
        root.setProperty("--flameNumB", "#ff8a2f");
        root.setProperty("--flameLabel", "#c98a00");
      }
    }

    function igniteFlameAndVibrate(){
      const flame = document.getElementById("flame");
      if(flame){
        flame.classList.remove("is-ignite");
        void flame.offsetWidth;
        flame.classList.add("is-ignite");
        setTimeout(()=> flame.classList.remove("is-ignite"), 950);
      }
      if (navigator.vibrate) navigator.vibrate([25, 40, 25]);
    }

    function showScreen(name){
      screenHome.classList.remove("active");
      screenHistory.classList.remove("active");
      screenStreak.classList.remove("active");

      navHome.classList.remove("active");
      navHistory.classList.remove("active");

      if(name==="home"){
        screenHome.classList.add("active");
        navHome.classList.add("active");
        setTimeout(refitAll, 0);
      }else if(name==="history"){
        screenHistory.classList.add("active");
        navHistory.classList.add("active");
        renderHistory();
      }else if(name==="streak"){
        screenStreak.classList.add("active");
      }
      window.scrollTo({top:0, behavior:"instant"});
    }

    // ====== Menu selection ======
    function decideMenuForMood(mood){
      const st = loadState();
      const t = todayKey();

      if(st.date === t && st.mood === mood && st.menuName && st.menuImg){
        return { name: st.menuName, img: st.menuImg };
      }

      const conf = MENUS[mood];
      const chosen = conf.random
        ? conf.random[Math.floor(Math.random()*conf.random.length)]
        : conf.fixed;

      saveState({ date:t, mood, menuName: chosen.name, menuImg: chosen.img });
      return chosen;
    }

    function applyMood(mood){
      [...moodTabs.querySelectorAll(".mood")].forEach(btn=>{
        btn.classList.toggle("selected", btn.dataset.mood===mood);
      });

      const conf = MENUS[mood];
      moodChip.innerHTML = `<span class="ico">${conf.ico}</span><span>${conf.label}</span>`;

      const chosen = decideMenuForMood(mood);
      menuTitle.textContent = chosen.name;
      menuImg.src = chosen.img;

      err.classList.remove("show");
      setTimeout(refitAll, 0);
    }

    // ====== Validation ======
    function validateInputs(){
      if(isBlank(stepsInput.value) || isBlank(minsInput.value)){
        err.classList.add("show");
        return false;
      }
      err.classList.remove("show");
      return true;
    }

    // ====== Logging ======
    function addLog({mood, menu, steps, mins}){
      const logs = loadLogs();
      logs.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date: todayKey(),
        time: nowTime(),
        mood,
        moodLabel: MENUS[mood].label,
        menu,
        steps: Number(steps),
        mins: Number(mins)
      });
      saveLogs(sortLogsByDateTimeDesc(logs));
      lastLine.textContent = `è¨˜éŒ²: ${todayKey()} ${nowTime()} / ${MENUS[mood].label} / ${menu} / ${steps}æ­© / ${mins}åˆ†`;
    }

    // âœ… éå»åˆ†ã‚’è¿½åŠ ï¼ˆæ™‚åˆ»ã¯å›ºå®š 12:00ï¼‰
    function addPastLog({date, mood, menu, steps, mins}){
      const logs = loadLogs();
      logs.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date,
        time: "12:00",
        mood,
        moodLabel: MENUS[mood].label,
        menu: (menu && String(menu).trim()) ? String(menu).trim() : "ï¼ˆæœªå…¥åŠ›ï¼‰",
        steps: Number(steps),
        mins: Number(mins)
      });
      saveLogs(sortLogsByDateTimeDesc(logs));
    }

    function computeStreak(){
      const logs = loadLogs();
      const days = new Set(logs.map(x => x.date));

      let streak = 0;
      let d = new Date();
      while(true){
        const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        if(days.has(key)){
          streak++;
          d.setDate(d.getDate()-1);
        }else{
          break;
        }
      }
      return streak;
    }

    // ====== History ======
    function renderHistory(){
      const logs = sortLogsByDateTimeDesc(loadLogs());
      historyList.innerHTML = "";

      if(!logs.length){
        historyList.innerHTML = `<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
        return;
      }

      logs.forEach(item=>{
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "rowLeft";
        left.innerHTML = `
          <div class="rowMain">${item.date} ${item.time} / ${item.moodLabel}</div>
          <div class="rowSub">${item.menu}ã€€ãƒ»ã€€${item.steps}æ­©ã€€ãƒ»ã€€${item.mins}åˆ†</div>
        `;

        const del = document.createElement("button");
        del.className = "del";
        del.type = "button";
        del.textContent = "æ¶ˆã™";
        del.onclick = ()=>{
          const next = loadLogs().filter(x=>x.id!==item.id);
          saveLogs(sortLogsByDateTimeDesc(next));
          renderHistory();
        };

        row.appendChild(left);
        row.appendChild(del);
        historyList.appendChild(row);
      });
    }

    function exportCSV(){
      const logs = sortLogsByDateTimeDesc(loadLogs());
      if(!logs.length){
        alert("å±¥æ­´ãŒç©ºã§ã™");
        return;
      }
      const header = ["date","time","mood","menu","steps","mins"];
      const lines = [header.join(",")];

      // å¤ã„â†’æ–°ã—ã„é †ã§åãå‡ºã—ï¼ˆExcelã§è¦‹ã‚„ã™ã„ï¼‰
      logs.slice().reverse().forEach(x=>{
        const esc = (s)=> `"${String(s).replaceAll('"','""')}"`;
        lines.push([esc(x.date), esc(x.time), esc(x.moodLabel), esc(x.menu), x.steps, x.mins].join(","));
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `workout_log_${todayKey()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== éå»åˆ†ãƒ•ã‚©ãƒ¼ãƒ ï¼šé–‹é–‰ ======
    function openPastForm(){
      pastForm.classList.add("show");
      pastForm.setAttribute("aria-hidden","false");
      pastErr.classList.remove("show");

      pastDate.value = todayKey();
      pastMood.value = (loadState().mood || "genki");
      pastMenu.value = "";
      pastSteps.value = "";
      pastMins.value = "";
    }

    function closePastForm(){
      pastForm.classList.remove("show");
      pastForm.setAttribute("aria-hidden","true");
      pastErr.classList.remove("show");
    }

    // ====== Events ======
    moodTabs.addEventListener("click", (e)=>{
      const btn = e.target.closest(".mood");
      if(!btn) return;
      applyMood(btn.dataset.mood);
    });

    // âœ… å…¥åŠ›ã™ã‚‹ãŸã³ã«ãƒ•ã‚£ãƒƒãƒˆ
    stepsInput.addEventListener("input", ()=> fitNumberInput(stepsInput));
    minsInput.addEventListener("input", ()=> fitNumberInput(minsInput));
    window.addEventListener("resize", ()=> setTimeout(refitAll, 0));

    btnDone.addEventListener("click", ()=>{
      if(!validateInputs()) return;

      const st = loadState();
      const mood = st.mood || "genki";
      const menu = st.menuName || menuTitle.textContent;

      addLog({ mood, menu, steps: stepsInput.value, mins: minsInput.value });

      const streak = computeStreak();
      streakNumEl.textContent = streak;
      setFlameThemeForStreak(streak);

      showScreen("streak");
      igniteFlameAndVibrate();
      stepsInput.select?.();
    });

    btnMore.addEventListener("click", ()=>{
      if(!validateInputs()) return;

      const st = loadState();
      const mood = st.mood || "genki";
      const menu = st.menuName || menuTitle.textContent;

      addLog({ mood, menu, steps: stepsInput.value, mins: minsInput.value });

      stepsInput.value = "";
      minsInput.value = "";
      err.classList.remove("show");
      stepsInput.focus();

      lastLine.textContent = `è¨˜éŒ²: ${todayKey()} ${nowTime()} / è¿½åŠ ã§è¨˜éŒ²ã—ãŸã‚ˆ`;
      setTimeout(refitAll, 0);
    });

    navHome.addEventListener("click", ()=> showScreen("home"));
    navHistory.addEventListener("click", ()=> showScreen("history"));
    btnBackHome.addEventListener("click", ()=> showScreen("home"));
    btnGoHistory.addEventListener("click", ()=> showScreen("history"));

    btnExport.addEventListener("click", exportCSV);

    btnClear.addEventListener("click", ()=>{
      if(confirm("å±¥æ­´ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ")){
        localStorage.removeItem(STORAGE_KEY);
        renderHistory();
      }
    });

    // âœ… éå»åˆ†è¿½åŠ ï¼ˆCï¼‰
    btnAddPast?.addEventListener("click", ()=>{
      if(pastForm.classList.contains("show")) closePastForm();
      else openPastForm();
    });
    btnPastCancel?.addEventListener("click", closePastForm);

    btnPastSave?.addEventListener("click", ()=>{
      const date = pastDate.value;
      const mood = pastMood.value;
      const menu = pastMenu.value;
      const steps = pastSteps.value;
      const mins = pastMins.value;

      if(isBlank(date) || isBlank(steps) || isBlank(mins)){
        pastErr.classList.add("show");
        return;
      }
      pastErr.classList.remove("show");

      addPastLog({ date, mood, menu, steps, mins });
      renderHistory();
      closePastForm();
    });

    // ====== Init ======
    (function init(){
      const st = loadState();
      const mood = st.mood || "genki";
      applyMood(mood);

      const logs = sortLogsByDateTimeDesc(loadLogs());
      if(logs.length){
        const x = logs[0];
        lastLine.textContent = `è¨˜éŒ²: ${x.date} ${x.time} / ${x.moodLabel} / ${x.menu} / ${x.steps}æ­© / ${x.mins}åˆ†`;
      }else{
        lastLine.textContent = "è¨˜éŒ²: ã¾ã ãªã—";
      }

      setFlameThemeForStreak(computeStreak());
      setTimeout(refitAll, 0);
    })();
  </script>
</body>
</html>