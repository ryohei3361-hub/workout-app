<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Workout Mood</title>
  <style>
    :root{
      --bg1:#f2f6ff;
      --bg2:#f7f3ff;
      --card:#ffffffcc;
      --shadow: 0 12px 26px rgba(0,0,0,.10);
      --shadow2: 0 10px 20px rgba(0,0,0,.12);
      --text:#111827;
      --muted:#6b7280;
      --brand:#2f6fff;
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
      --tab:#e8f1ff;
      --tab2:#eef2ff;
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, var(--bg2), transparent 60%),
                  radial-gradient(1200px 800px at 80% 20%, var(--bg1), transparent 60%),
                  linear-gradient(180deg, #f8fbff, #f6f7ff);
      min-height:100vh;
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      padding: 22px 18px 96px;
    }

    h1{
      margin: 18px 0 18px;
      font-size: 34px;
      letter-spacing:.02em;
      text-align:center;
      font-weight:900;
    }

    /* mood pills (4) */
    .moodRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 0 auto 16px;
    }
    .moodPill{
      border:0;
      padding: 10px 10px;
      border-radius: 16px;
      background: #ffffffb3;
      box-shadow: 0 8px 16px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:800;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .12s ease;
      user-select:none;
    }
    .moodPill:active{ transform: scale(.99); }
    .moodPill[aria-pressed="true"]{
      outline: 3px solid rgba(47,111,255,.25);
      box-shadow: 0 12px 24px rgba(47,111,255,.14);
      background: #ffffff;
    }

    /* main card */
    .panel{
      background: var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.6);
    }

    .panelHeader{
      padding: 16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:16px;
      padding: 8px 12px;
      border-radius: 14px;
      background: rgba(47,111,255,.08);
    }
    .today{
      color:var(--muted);
      font-weight:800;
      font-size: 13px;
      text-align:right;
      white-space:nowrap;
    }

    .banner{
      width:100%;
      height: 150px;
      display:block;
      object-fit: cover;
      background: #eef2ff;
      border-top: 1px solid rgba(255,255,255,.8);
      border-bottom: 1px solid rgba(255,255,255,.8);
    }

    .content{
      padding: 14px 16px 16px;
    }
    .menuTitle{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 900;
    }

    .inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0 12px;
    }

    .field{
      background: #fff;
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,.07);
      border: 1px solid rgba(17,24,39,.06);
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    input{
      width:100%;
      font-size: 18px;
      font-weight: 900;
      border:0;
      outline:none;
      background:transparent;
    }
    input::placeholder{ color:#c7cdd9; font-weight:800; }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 6px;
    }
    .btn{
      border:0;
      border-radius: 18px;
      padding: 14px 14px;
      font-size: 18px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, filter .12s ease;
    }
    .btn:active{ transform: scale(.99); }

    .btnPrimary{
      background: linear-gradient(180deg, #ff8a3d, #ff5b2a);
      color:white;
    }
    .btnSecondary{
      background: linear-gradient(180deg, #2f83ff, #2f6fff);
      color:white;
    }
    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      font-weight:800;
    }
    .error{
      margin-top: 10px;
      font-size: 13px;
      color: #b91c1c;
      font-weight: 900;
      text-align:center;
      display:none;
    }
    .error.show{ display:block; }

    /* bottom tabs */
    .tabBar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,.06);
      display:flex;
      justify-content:center;
    }
    .tabWrap{
      width:min(520px, 100%);
      display:flex;
      gap: 10px;
    }
    .tab{
      flex:1;
      border:0;
      background: #f4f7ff;
      border-radius: 18px;
      padding: 10px 12px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      font-weight: 950;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      color:#1f2937;
    }
    .tab[aria-selected="true"]{
      background: #e8f1ff;
      outline: 3px solid rgba(47,111,255,.18);
      color:#0b4bff;
    }
    .tab svg{ width:20px; height:20px; }

    /* screens */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* logs */
    .logsTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 14px 0;
    }
    .logsTitle{
      font-size: 22px;
      font-weight: 1000;
      margin:0;
    }
    .miniBtnRow{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .miniBtn{
      border:0;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      cursor:pointer;
      background: #ffffff;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }
    .miniBtn.danger{ color:white; background: #ef4444; }
    .miniBtn.ok{ color:white; background: #16a34a; }

    .logList{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .logItem{
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      padding: 12px 12px;
      border: 1px solid rgba(0,0,0,.05);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .logLeft{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 0;
    }
    .logLine1{
      font-weight: 1000;
      font-size: 14px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(47,111,255,.08);
      font-weight: 950;
      font-size: 12px;
    }
    .logLine2{
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 360px;
    }
    .logRight{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-shrink:0;
    }
    .iconBtn{
      border:0;
      background:#ffffff;
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      font-weight: 1000;
      color:#111827;
    }
    .iconBtn.trash{ background:#fee2e2; color:#991b1b; }

    /* streak screen */
    .overlay{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }

    .streakCard{
      width: min(420px, 100%);
      background: white;
      border-radius: 26px;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
      padding: 22px 18px 16px;
      text-align:center;
      overflow:hidden;
      position:relative;
    }
    .flame{
      width: 92px;
      height: 92px;
      margin: 4px auto 6px;
      display:grid;
      place-items:center;
      border-radius: 26px;
      background: radial-gradient(circle at 30% 30%, #ffd27a, #ff7a2a 55%, #ff3b30 100%);
      box-shadow: 0 18px 30px rgba(255,122,42,.35);
      transform: translateY(8px) scale(.94);
      opacity: 0;
      animation: pop .55s cubic-bezier(.2,1,.2,1) forwards;
    }
    @keyframes pop{
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .flame svg{ width: 52px; height: 52px; filter: drop-shadow(0 8px 14px rgba(0,0,0,.22)); }

    .streakNum{
      font-size: 64px;
      font-weight: 1100;
      margin: 4px 0 2px;
      color: #ff6b2a;
      letter-spacing:.02em;
      opacity:0;
      transform: translateY(10px);
      animation: up .45s .12s ease forwards;
    }
    .streakSub{
      margin: 0 0 14px;
      font-size: 18px;
      font-weight: 1000;
      color:#111827;
      opacity:0;
      transform: translateY(10px);
      animation: up .45s .18s ease forwards;
    }
    @keyframes up{
      to{ opacity:1; transform: translateY(0); }
    }
    .streakBar{
      margin: 10px auto 18px;
      width: 100%;
      max-width: 340px;
      height: 18px;
      border-radius: 999px;
      background: #f3f4f6;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
    }
    .streakFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #ff8a3d, #ff3b30);
      border-radius: 999px;
      animation: fill 1s .25s ease forwards;
    }
    @keyframes fill{
      to{ width: 100%; }
    }
    .closeBtn{
      width: 100%;
      border:0;
      border-radius: 18px;
      padding: 14px 14px;
      font-size: 18px;
      font-weight: 1100;
      background: #2f6fff;
      color:white;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }

    .smallNote{
      font-size: 12px;
      color: var(--muted);
      font-weight: 850;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- HOME -->
    <section id="homeScreen" class="screen active">
      <h1>‰ªäÊó•„ÅÆ‰ΩìË™ø„ÅØÔºü</h1>

      <div class="moodRow" role="group" aria-label="‰ΩìË™øÈÅ∏Êäû">
        <button class="moodPill" data-mood="genki" aria-pressed="true">üî•<span>ÂÖÉÊ∞ó</span></button>
        <button class="moodPill" data-mood="futsu" aria-pressed="false">üôÇ<span>„Åµ„Å§„ÅÜ</span></button>
        <button class="moodPill" data-mood="shindoi" aria-pressed="false">üòµ‚Äçüí´<span>„Åó„Çì„Å©„ÅÑ</span></button>
        <button class="moodPill" data-mood="rest" aria-pressed="false">üêæ<span>‰ºëÊÅØ</span></button>
      </div>

      <div class="panel">
        <div class="panelHeader">
          <div class="badge" id="moodBadge">üî• ÂÖÉÊ∞ó</div>
          <div class="today" id="todayText"></div>
        </div>

        <img id="bannerImg" class="banner" alt="„É°„Éã„É•„ÉºÁîªÂÉè" src="assets/fitboxing.png" />

        <div class="content">
          <p class="menuTitle" id="menuTitle">Fit Boxing</p>

          <div class="inputs">
            <div class="field">
              <div class="label">‰ªäÊó•„ÅÆÊ≠©Êï∞</div>
              <input id="stepsInput" inputmode="numeric" pattern="[0-9]*" placeholder="‰æã: 6500" />
            </div>
            <div class="field">
              <div class="label">ÈÅãÂãïÔºàÂàÜÔºâ</div>
              <input id="minsInput" inputmode="numeric" pattern="[0-9]*" placeholder="‰æã: 25" />
            </div>
          </div>

          <div class="btnRow">
            <button id="doneBtn" class="btn btnPrimary">„ÇÑ„Å£„ÅüÔºÅ</button>
            <button id="moreBtn" class="btn btnSecondary">„ÇÇ„ÅÜ1„Å§„ÇÑ„Çã</button>
          </div>

          <div id="err" class="error">Ê≠©Êï∞„Å®ÂàÜÊï∞„ÅØÁ©∫Ê¨ÑNG„Åß„ÅôÔºà0„Åß„ÇÇOKÔºâ„ÄÇ</div>
          <div class="hint" id="lastRecordHint">Ë®òÈå≤: „Å™„Åó</div>
        </div>
      </div>

      <p class="smallNote">
        ‚Äª„Äå‰ºëÊÅØ„Äç„ÇÇ‚ÄúËß¶„Å£„ÅüË®òÈå≤‚Äù„Å®„Åó„Å¶ÈÄ£Á∂öÊó•Êï∞„Å´„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åô„ÄÇ<br/>
        ‚Äª„É≠„Ç∞„ÅØ1Êó•„Å´Ë§áÊï∞ÂõûOKÔºà„Äå„ÇÇ„ÅÜ1„Å§„ÇÑ„Çã„ÄçÔºâ„ÄÇ
      </p>
    </section>

    <!-- LOGS -->
    <section id="logsScreen" class="screen">
      <div class="logsTop">
        <h2 class="logsTitle">Â±•Ê≠¥</h2>
        <div class="miniBtnRow">
          <button id="exportBtn" class="miniBtn ok">ExcelÂá∫Âäõ</button>
          <button id="clearBtn" class="miniBtn danger">ÂÖ®ÂâäÈô§</button>
        </div>
      </div>

      <div class="panel" style="padding:14px 14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:1000;">ÈÄ£Á∂öË®òÈå≤</div>
          <div id="streakText" style="font-weight:1100;color:#ff6b2a;">0Êó•</div>
        </div>
        <div style="margin-top:10px;color:var(--muted);font-weight:900;font-size:13px;">
          „Äå„Åù„ÅÆÊó•„Å´1Âõû„Åß„ÇÇ‚Äú„ÇÑ„Å£„ÅüÔºÅ‚ÄùÔºà‰ºëÊÅØ„ÇÇÂê´„ÇÄÔºâ„Äç„ÅßÈÄ£Á∂ö„Ç´„Ç¶„É≥„Éà„ÄÇ
        </div>
      </div>

      <div style="height:12px;"></div>
      <div id="logList" class="logList"></div>
      <div id="emptyLogs" style="margin-top:18px;color:var(--muted);font-weight:900;text-align:center;display:none;">
        „Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
      </div>
    </section>
  </div>

  <!-- Bottom Tabs -->
  <div class="tabBar">
    <div class="tabWrap">
      <button id="tabHome" class="tab" aria-selected="true">
        <svg viewBox="0 0 24 24" fill="none"><path d="M3 10.5 12 3l9 7.5v9.5a1.5 1.5 0 0 1-1.5 1.5H15v-7H9v7H4.5A1.5 1.5 0 0 1 3 20V10.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
        „Éõ„Éº„É†
      </button>
      <button id="tabLogs" class="tab" aria-selected="false">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M21 12a9 9 0 1 1-9-9 9 9 0 0 1 9 9Z" stroke="currentColor" stroke-width="2"/></svg>
        Â±•Ê≠¥
      </button>
    </div>
  </div>

  <!-- Streak overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="ÈÄ£Á∂öË®òÈå≤">
    <div class="streakCard">
      <div class="flame" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M13.5 2s.5 4-2.5 6c-2.3 1.6-2.2 4.1-.7 5.4 1.2 1 3.1.7 4.2-.5 1.2-1.3 1.6-3.6-.2-5.7 4 1.6 6 5 6 8.4A7.5 7.5 0 1 1 5 16c0-3.1 1.7-5.8 4.2-7.3C11.6 7.3 13.1 5.1 13.5 2Z" fill="rgba(255,255,255,.92)"/>
        </svg>
      </div>
      <div id="streakNum" class="streakNum">0</div>
      <div class="streakSub">Êó•ÈÄ£Á∂ö</div>
      <div class="streakBar"><div class="streakFill"></div></div>
      <button id="closeOverlay" class="closeBtn">OK</button>
    </div>
  </div>

  <script>
    // ====== Storage ======
    const KEY = "workout_mood_records_v1";

    /** @typedef {{id:string, date:string, time:string, mood:string, menu:string, steps:number, minutes:number}} Record */

    function loadRecords(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        return arr;
      }catch(e){
        return [];
      }
    }
    function saveRecords(records){
      localStorage.setItem(KEY, JSON.stringify(records));
    }

    function pad(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function timeHM(){
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ====== Menus ======
    const moodMeta = {
      genki:   { label:"ÂÖÉÊ∞ó",   icon:"üî•", badge:"üî• ÂÖÉÊ∞ó",  color:"rgba(255,122,42,.10)" },
      futsu:   { label:"„Åµ„Å§„ÅÜ", icon:"üôÇ", badge:"üôÇ „Åµ„Å§„ÅÜ", color:"rgba(47,111,255,.10)" },
      shindoi: { label:"„Åó„Çì„Å©„ÅÑ", icon:"üòµ‚Äçüí´", badge:"üòµ‚Äçüí´ „Åó„Çì„Å©„ÅÑ", color:"rgba(168,85,247,.10)" },
      rest:    { label:"‰ºëÊÅØ",   icon:"üêæ", badge:"üêæ ‰ºëÊÅØ",  color:"rgba(99,102,241,.10)" },
    };

    // „É©„É≥„ÉÄ„É†ÊÄßÔºöÂÖÉÊ∞ó„Å†„ÅëÔºàÂÜçÊäΩÈÅ∏„ÅØ‰∏çË¶Å„Å®„ÅÆ„Åì„Å®„Å™„ÅÆ„Åß„Äå„Åù„ÅÆÊó•ÊúÄÂàù„Å´Ê±∫„Åæ„Å£„Åü„ÇÇ„ÅÆ„ÇíÂõ∫ÂÆö„ÄçÔºâ
    const genkiPool = [
      { menu:"Ring Fit",        img:"assets/ringfit.png" },
      { menu:"Fit Boxing",      img:"assets/fitboxing.png" },
      { menu:"HOP!STEP!DANCE!", img:"assets/hopstepdance.png" }
    ];

    // Âõ∫ÂÆö„É°„Éã„É•„Éº
    const fixedMenu = {
      futsu:   { menu:"„É™„É≥„Ç∞„Éï„Ç£„ÉÉ„ÉàÔºà„Ç¶„Ç©„Éº„Ç≠„É≥„Ç∞„É¢„Éº„ÉâÔºâ + YouTube 1Êú¨", img:"assets/ringfit.png" },
      shindoi: { menu:"YouTube „É®„Ç¨ 1Êú¨ + ÂØù„ÇãÂâç Stretch 1Êú¨",              img:"assets/yoga.png" },
      rest:    { menu:"Stretch 5ÂàÜ / ‰ºë„ÇÄ",                                   img:"assets/rest.png" },
    };

    // ÂÖÉÊ∞ó„ÅÆ„Äå„Åù„ÅÆÊó•Âõ∫ÂÆö„ÄçÁî®„Ç≠„Éº
    const GENKI_DAILY_KEY = "workout_mood_genki_daily_pick";

    function getGenkiPickForToday(){
      const today = todayISO();
      try{
        const raw = localStorage.getItem(GENKI_DAILY_KEY);
        if(raw){
          const obj = JSON.parse(raw);
          if(obj && obj.date === today && obj.pickIndex >= 0 && obj.pickIndex < genkiPool.length){
            return genkiPool[obj.pickIndex];
          }
        }
      }catch(e){}
      const pickIndex = Math.floor(Math.random()*genkiPool.length);
      localStorage.setItem(GENKI_DAILY_KEY, JSON.stringify({ date: today, pickIndex }));
      return genkiPool[pickIndex];
    }

    function getMenuForMood(mood){
      if(mood === "genki") return getGenkiPickForToday();
      return fixedMenu[mood];
    }

    // ====== Streak ======
    // ÈÄ£Á∂öÊó•Êï∞ = ‰ªäÊó•„Åã„ÇâÈÅ°„Å£„Å¶„ÄÅË®òÈå≤„Åå„ÅÇ„ÇãÊó•„ÅåÈÄîÂàá„Çå„Çã„Åæ„ÅßÊï∞„Åà„Çã
    function calcStreak(records){
      const dates = new Set(records.map(r => r.date));
      let count = 0;
      const d = new Date();
      while(true){
        const iso = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        if(dates.has(iso)){
          count++;
          d.setDate(d.getDate()-1);
        }else{
          break;
        }
      }
      return count;
    }

    // ====== UI refs ======
    const homeScreen = document.getElementById("homeScreen");
    const logsScreen = document.getElementById("logsScreen");
    const tabHome = document.getElementById("tabHome");
    const tabLogs = document.getElementById("tabLogs");

    const moodButtons = Array.from(document.querySelectorAll(".moodPill"));
    const moodBadge = document.getElementById("moodBadge");
    const todayText = document.getElementById("todayText");
    const bannerImg = document.getElementById("bannerImg");
    const menuTitle = document.getElementById("menuTitle");
    const stepsInput = document.getElementById("stepsInput");
    const minsInput  = document.getElementById("minsInput");
    const doneBtn = document.getElementById("doneBtn");
    const moreBtn = document.getElementById("moreBtn");
    const err = document.getElementById("err");
    const lastRecordHint = document.getElementById("lastRecordHint");

    const logList = document.getElementById("logList");
    const emptyLogs = document.getElementById("emptyLogs");
    const clearBtn = document.getElementById("clearBtn");
    const exportBtn = document.getElementById("exportBtn");
    const streakText = document.getElementById("streakText");

    const overlay = document.getElementById("overlay");
    const streakNum = document.getElementById("streakNum");
    const closeOverlay = document.getElementById("closeOverlay");

    // ====== State ======
    let currentMood = "genki";
    let currentMenu = getMenuForMood(currentMood);

    function setTodayLabel(){
      const d = new Date();
      const w = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"][d.getDay()];
      todayText.textContent = `${todayISO()}Ôºà${w}Ôºâ`;
    }

    function applyMood(mood){
      currentMood = mood;

      moodButtons.forEach(btn => {
        btn.setAttribute("aria-pressed", btn.dataset.mood === mood ? "true" : "false");
      });

      // menu
      currentMenu = getMenuForMood(mood);

      // badge
      moodBadge.textContent = moodMeta[mood].badge;
      moodBadge.style.background = moodMeta[mood].color;

      // banner + title
      bannerImg.src = currentMenu.img;
      menuTitle.textContent = currentMenu.menu;

      // error hidden
      err.classList.remove("show");
    }

    moodButtons.forEach(btn => {
      btn.addEventListener("click", () => applyMood(btn.dataset.mood));
    });

    function showScreen(name){
      const isHome = name === "home";
      homeScreen.classList.toggle("active", isHome);
      logsScreen.classList.toggle("active", !isHome);
      tabHome.setAttribute("aria-selected", isHome ? "true" : "false");
      tabLogs.setAttribute("aria-selected", !isHome ? "true" : "false");
      if(!isHome) renderLogs();
    }

    tabHome.addEventListener("click", () => showScreen("home"));
    tabLogs.addEventListener("click", () => showScreen("logs"));

    function validateRequired(){
      // Á©∫Ê¨ÑNG„ÄÅ0„ÅØOK
      const stepsRaw = stepsInput.value.trim();
      const minsRaw  = minsInput.value.trim();
      if(stepsRaw === "" || minsRaw === "") return null;

      // Êï∞Â≠óÂåñÔºà„Ç´„É≥„ÉûÊ∑∑ÂÖ•„ÇíË®±ÂÆπÔºâ
      const steps = Number(stepsRaw.replace(/,/g,""));
      const minutes = Number(minsRaw.replace(/,/g,""));
      if(Number.isNaN(steps) || Number.isNaN(minutes)) return null;
      if(steps < 0 || minutes < 0) return null;

      return { steps, minutes };
    }

    function updateLastHint(){
      const records = loadRecords();
      if(records.length === 0){
        lastRecordHint.textContent = "Ë®òÈå≤: „Å™„Åó";
        return;
      }
      const r = records[0]; // ÊúÄÊñ∞„ÇíÂÖàÈ†≠„Å´„Åó„Å¶„ÅÑ„ÇãÂâçÊèêÔºà‰øùÂ≠òÊôÇ„Å´ÂÖàÈ†≠unshiftÔºâ
      lastRecordHint.textContent = `Ë®òÈå≤: ${r.date}, ${moodMeta[r.mood].label}, ${r.steps}Ê≠©, ${r.minutes}ÂàÜ`;
    }

    function addRecord(){
      const validated = validateRequired();
      if(!validated){
        err.classList.add("show");
        return null;
      }
      err.classList.remove("show");

      const record = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date: todayISO(),
        time: timeHM(),
        mood: currentMood,
        menu: currentMenu.menu,
        steps: validated.steps,
        minutes: validated.minutes
      };

      const records = loadRecords();
      records.unshift(record);
      saveRecords(records);

      // ÂÖ•ÂäõÊ¨Ñ„É™„Çª„ÉÉ„ÉàÔºà„ÇÑ„Çä„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´Ôºâ
      // „Äå„ÇÇ„ÅÜ1„Å§„ÇÑ„Çã„ÄçÂâçÊèê„Å™„ÅÆ„Åß„ÄÅsteps„ÅØÊÆã„Åó„Å¶minutes„Å†„ÅëÊ∂à„ÅôÈÅãÁî®„ÇÇËÄÉ„Åà„Åü„Åë„Å©„ÄÅ„Åæ„Åö„ÅØ‰∏°Êñπ„ÇØ„É™„Ç¢„Å´Áµ±‰∏Ä
      stepsInput.value = "";
      minsInput.value = "";

      updateLastHint();
      return record;
    }

    function showStreakOverlay(){
      const records = loadRecords();
      const streak = calcStreak(records);
      streakNum.textContent = String(streak);
      overlay.classList.add("show");
    }

    doneBtn.addEventListener("click", () => {
      const rec = addRecord();
      if(!rec) return;
      // ‚Äú„ÇÑ„Å£„ÅüÔºÅ‚Äù„ÅØÈÄ£Á∂öÁîªÈù¢„Å∏
      showStreakOverlay();
    });

    moreBtn.addEventListener("click", () => {
      const rec = addRecord();
      if(!rec) return;
      // ‚Äú„ÇÇ„ÅÜ1„Å§„ÇÑ„Çã‚Äù„ÅØÈÄ£Á∂öÁîªÈù¢„ÅØÂá∫„Åï„Å™„ÅÑÔºà„ÉÜ„É≥„ÉùÂÑ™ÂÖàÔºâ
      // „Åß„ÇÇÂ∏åÊúõ„Åå„ÅÇ„Çå„Å∞„Åì„Åì„ÇÇÂá∫„Åõ„Çã
    });

    closeOverlay.addEventListener("click", () => {
      overlay.classList.remove("show");
      // „Éõ„Éº„É†„Å´Êàª„ÇãÔºà‰ªä„ÅØ„Éõ„Éº„É†„ÅÆ„Åæ„ÅæÔºâ
    });
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) overlay.classList.remove("show");
    });

    // ====== Logs UI ======
    function renderLogs(){
      const records = loadRecords();
      const streak = calcStreak(records);
      streakText.textContent = `${streak}Êó•`;

      logList.innerHTML = "";
      emptyLogs.style.display = records.length ? "none" : "block";

      records.forEach((r) => {
        const item = document.createElement("div");
        item.className = "logItem";

        const left = document.createElement("div");
        left.className = "logLeft";

        const line1 = document.createElement("div");
        line1.className = "logLine1";
        line1.innerHTML = `
          <span class="tag">${r.date}</span>
          <span class="tag">${moodMeta[r.mood].icon} ${moodMeta[r.mood].label}</span>
          <span class="tag">${r.steps}Ê≠©</span>
          <span class="tag">${r.minutes}ÂàÜ</span>
        `;

        const line2 = document.createElement("div");
        line2.className = "logLine2";
        line2.textContent = `${r.time} / ${r.menu}`;

        left.appendChild(line1);
        left.appendChild(line2);

        const right = document.createElement("div");
        right.className = "logRight";

        const del = document.createElement("button");
        del.className = "iconBtn trash";
        del.textContent = "ÂâäÈô§";
        del.addEventListener("click", () => {
          const next = loadRecords().filter(x => x.id !== r.id);
          saveRecords(next);
          renderLogs();
          updateLastHint();
        });

        right.appendChild(del);

        item.appendChild(left);
        item.appendChild(right);
        logList.appendChild(item);
      });
    }

    clearBtn.addEventListener("click", () => {
      if(!confirm("Â±•Ê≠¥„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) return;
      localStorage.removeItem(KEY);
      // ÂÖÉÊ∞ó„ÅÆ„Åù„ÅÆÊó•Âõ∫ÂÆö„ÅØÊÆã„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åå„ÄÅÂÆåÂÖ®„Å´„ÉÜ„Çπ„Éà„Çí„ÇÑ„ÇäÁõ¥„Åô„Å™„ÇâÊ∂à„Åó„Åü„ÅÑÂ†¥Âêà„ÇÇ„ÅÇ„Çã
      // „Åì„Åì„Åß„ÅØÊÆã„Åô
      renderLogs();
      updateLastHint();
    });

    exportBtn.addEventListener("click", () => {
      const records = loadRecords();
      if(records.length === 0){
        alert("Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
        return;
      }

      // Excel„ÅßÈñã„Åë„ÇãCSV
      const header = ["date","time","mood","menu","steps","minutes"];
      const rows = records.slice().reverse().map(r => [
        r.date,
        r.time,
        moodMeta[r.mood].label,
        r.menu,
        String(r.steps),
        String(r.minutes),
      ]);

      const csv = [header, ...rows].map(cols =>
        cols.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")
      ).join("\n");

      const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `workout_log_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ====== Init ======
    setTodayLabel();
    applyMood("genki");
    updateLastHint();

    // ÁîªÂÉè„ÅåÁÑ°„ÅÑÂ†¥Âêà„Åß„ÇÇÁîªÈù¢„ÅåÂ¥©„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºà„Åü„Å†„ÅóÂ∑Æ„ÅóÊõø„ÅàÊé®Â•®Ôºâ
    bannerImg.addEventListener("error", () => {
      bannerImg.style.background = "#eef2ff";
    });
  </script>
</body>
</html>
