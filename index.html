<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Workout App</title>

  <style>
    :root{
      --bg1:#eaf3ff;
      --bg2:#f7f0ff;
      --bg3:#fff7e9;
      --card:#ffffffcc;
      --stroke:#ffffffb3;
      --shadow: 0 18px 40px rgba(26, 38, 64, 0.10);
      --shadow2: 0 10px 22px rgba(26, 38, 64, 0.12);
      --text:#1f2a44;
      --muted:#6b7a99;

      --accent1:#ffb400; /* å…ƒæ°— */
      --accent2:#38c3ff; /* ãµã¤ã† */
      --accent3:#7a6cff; /* ã—ã‚“ã©ã„ */
      --accent4:#a7b2c6; /* ä¼‘æ¯ */

      --btnOrange1:#ffb35a;
      --btnOrange2:#ff7e2a;
      --btnBlue1:#76b5ff;
      --btnBlue2:#2d6bff;

      --radius:22px;
      --tabRadius:18px;

      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeTop: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 10% 20%, rgba(255,255,255,0.9), transparent 55%),
        radial-gradient(900px 700px at 85% 15%, rgba(255,255,255,0.7), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 45%, var(--bg3));
      overflow-x:hidden;
    }

    /* ã‚­ãƒ©ã‚­ãƒ©æˆåˆ†ï¼ˆèƒŒæ™¯ï¼‰ */
    .sparkles{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.55), transparent 45%),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,0.40), transparent 45%),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,0.35), transparent 50%);
      opacity:.9;
    }
    .sparkles::before,
    .sparkles::after{
      content:"";
      position:absolute;
      inset:-20%;
      background-image:
        radial-gradient(circle, rgba(255,255,255,0.85) 0 2px, transparent 3px),
        radial-gradient(circle, rgba(255,255,255,0.65) 0 1.5px, transparent 2.5px),
        radial-gradient(circle, rgba(255,255,255,0.55) 0 1px, transparent 2px);
      background-size: 280px 280px, 200px 200px, 140px 140px;
      background-position: 0 0, 40px 70px, 90px 20px;
      filter: blur(0.2px);
      opacity:.55;
      animation: drift 14s linear infinite;
    }
    .sparkles::after{
      opacity:.35;
      animation-duration: 22s;
      transform: scale(1.15);
    }
    @keyframes drift{
      0%{ transform: translate3d(0,0,0); }
      100%{ transform: translate3d(-80px, 60px, 0); }
    }

    .app{
      position:relative;
      z-index:1;
      max-width: 520px;
      margin: 0 auto;
      padding: calc(18px + var(--safeTop)) 14px calc(130px + var(--safeBottom));
    }

    h1{
      margin: 16px 0 16px;
      font-size: 38px;
      letter-spacing: 0.02em;
      text-align:center;
      font-weight: 900;
      color: rgba(20, 30, 55, 0.85);
      text-shadow: 0 10px 22px rgba(255,255,255,0.7);
    }

    /* ä½“èª¿ã‚¿ãƒ–ï¼ˆç†æƒ³ã®ã‚«ãƒ©ãƒ•ãƒ«ãªãƒœã‚¿ãƒ³ï¼‰ */
    .mood-tabs{
      display:flex;
      gap: 12px;
      justify-content:space-between;
      margin: 10px 0 16px;
    }
    .mood-tab{
      flex:1;
      border: 1px solid rgba(255,255,255,0.9);
      background: rgba(255,255,255,0.75);
      border-radius: 18px;
      padding: 12px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight: 900;
      box-shadow: 0 10px 20px rgba(26, 38, 64, 0.10);
      transition: transform .08s ease, box-shadow .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .mood-tab:active{ transform: scale(0.98); }
    .mood-tab span.emoji{ font-size: 18px; }
    .mood-tab.active{
      border-color: rgba(255,255,255,0.95);
      box-shadow: 0 16px 28px rgba(26, 38, 64, 0.12);
    }
    .mood-tab[data-mood="genki"].active{
      background: linear-gradient(180deg, rgba(255,206,109,0.95), rgba(255,180,0,0.85));
      color: #1f2a44;
    }
    .mood-tab[data-mood="futsu"].active{
      background: linear-gradient(180deg, rgba(168,241,255,0.95), rgba(56,195,255,0.75));
      color:#0b3a55;
    }
    .mood-tab[data-mood="shindoi"].active{
      background: linear-gradient(180deg, rgba(205,193,255,0.95), rgba(122,108,255,0.75));
      color:#1a1544;
    }
    .mood-tab[data-mood="rest"].active{
      background: linear-gradient(180deg, rgba(230,236,246,0.95), rgba(167,178,198,0.75));
      color:#27314a;
    }

    /* ã‚«ãƒ¼ãƒ‰ï¼ˆä¸­å¤®ã®å¤§æ ï¼‰ */
    .panel{
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.85);
      border-radius: 28px;
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.9);
      background: rgba(255,255,255,0.70);
      font-weight: 900;
      box-shadow: 0 10px 20px rgba(26, 38, 64, 0.08);
      margin-bottom: 10px;
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .menuTitle{
      font-size: 44px;
      font-weight: 1000;
      letter-spacing: 0.02em;
      margin:0;
      line-height: 1;
    }

    /* ãƒãƒŠãƒ¼æ ï¼šé«˜ã•å›ºå®šã‚’ã‚„ã‚ã€ç”»åƒã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
    .bannerFrame{
      margin: 8px 0 14px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.85);
      border-radius: 22px;
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .bannerFrame img{
      width:100%;
      height:auto;          /* é‡è¦ï¼šç¸¦ã¯è‡ªå‹• */
      display:block;
      border-radius: 16px;
    }

    .statsRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 10px 0 14px;
    }
    .statBox{
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(255,255,255,0.90);
      border-radius: 18px;
      padding: 12px 12px 10px;
      box-shadow: 0 10px 20px rgba(26, 38, 64, 0.08);
    }
    .statLabel{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      color: rgba(31,42,68,0.75);
      margin-bottom: 8px;
      font-size: 15px;
    }
    .statValueRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .statInput{
      width: 100%;
      font-size: 46px;
      font-weight: 1000;
      border:none;
      outline:none;
      background: transparent;
      color: rgba(31,42,68,0.92);
      line-height: 1;
    }
    .unit{
      font-size: 18px;
      font-weight: 900;
      color: rgba(31,42,68,0.45);
      padding-bottom: 6px;
    }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 6px;
    }
    .btn{
      border:none;
      border-radius: 18px;
      padding: 18px 14px;
      font-size: 22px;
      font-weight: 1000;
      color: white;
      box-shadow: 0 18px 30px rgba(26, 38, 64, 0.14);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease;
    }
    .btn:active{ transform: scale(0.99); }
    .btn.orange{
      background: linear-gradient(180deg, var(--btnOrange1), var(--btnOrange2));
    }
    .btn.blue{
      background: linear-gradient(180deg, var(--btnBlue1), var(--btnBlue2));
    }

    .meta{
      margin-top: 10px;
      text-align:center;
      color: rgba(31,42,68,0.55);
      font-weight: 800;
      font-size: 14px;
    }

    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* å±¥æ­´ */
    .historyHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .historyTitle{
      font-size: 34px;
      font-weight: 1000;
      margin: 10px 0 0;
    }
    .ghostBtn{
      border: 1px solid rgba(255,255,255,0.9);
      background: rgba(255,255,255,0.65);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      color: rgba(31,42,68,0.75);
      box-shadow: 0 10px 18px rgba(26, 38, 64, 0.08);
      cursor:pointer;
    }
    .historyList{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .logItem{
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(255,255,255,0.9);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: 0 10px 18px rgba(26, 38, 64, 0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .logLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .logTop{
      font-weight: 1000;
      color: rgba(31,42,68,0.90);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .logSub{
      font-weight: 800;
      color: rgba(31,42,68,0.55);
      font-size: 13px;
    }
    .dangerBtn{
      border:none;
      background: rgba(255,80,80,0.15);
      color: rgba(180,40,40,0.95);
      font-weight: 1000;
      border-radius: 14px;
      padding: 10px 10px;
      cursor:pointer;
      white-space:nowrap;
    }

    /* é€£ç¶šè¨˜éŒ²ï¼ˆDuolingoé¢¨ï¼‰ */
    .streakOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.28);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
      padding: 16px;
    }
    .streakOverlay.show{ display:flex; }
    .streakCard{
      width: min(440px, 100%);
      border-radius: 28px;
      padding: 22px 18px 18px;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(255,255,255,0.92), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.82));
      border: 1px solid rgba(255,255,255,0.9);
      box-shadow: 0 30px 80px rgba(0,0,0,0.22);
      text-align:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .streakFlame{
      font-size: 68px;
      filter: drop-shadow(0 10px 18px rgba(255,140,0,0.35));
      animation: pop .35s ease-out;
    }
    .streakNum{
      font-size: 74px;
      font-weight: 1100;
      margin: 8px 0 6px;
      background: linear-gradient(180deg, #ffbb55, #ff6a2a);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: pop .35s ease-out;
    }
    .streakLabel{
      font-size: 22px;
      font-weight: 1000;
      color: rgba(31,42,68,0.72);
      margin-bottom: 12px;
    }
    .streakDays{
      display:flex;
      justify-content:center;
      gap: 8px;
      margin: 10px 0 16px;
    }
    .dot{
      width: 34px;
      height: 10px;
      border-radius: 999px;
      background: rgba(31,42,68,0.10);
      border: 1px solid rgba(255,255,255,0.8);
    }
    .dot.on{
      background: linear-gradient(90deg, #ffbb55, #ff6a2a);
      box-shadow: 0 10px 20px rgba(255,120,40,0.28);
    }
    .streakNext{
      width: 100%;
      border:none;
      border-radius: 18px;
      padding: 16px 14px;
      font-size: 20px;
      font-weight: 1100;
      color:white;
      background: linear-gradient(180deg, #38c3ff, #2d6bff);
      box-shadow: 0 18px 30px rgba(26, 38, 64, 0.14);
      cursor:pointer;
    }
    @keyframes pop{
      from{ transform: scale(0.86); opacity: 0.2; }
      to{ transform: scale(1); opacity: 1; }
    }

    /* ä¸‹ã®å›ºå®šãƒãƒ¼ï¼ˆãƒ›ãƒ¼ãƒ /å±¥æ­´ï¼‰ */
    .bottomBar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      padding: 10px 14px calc(10px + var(--safeBottom));
      display:flex;
      justify-content:center;
    }
    .bottomInner{
      width: min(520px, 100%);
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(255,255,255,0.9);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 10px;
    }
    .navBtn{
      border:none;
      background: transparent;
      border-radius: 18px;
      padding: 12px 10px;
      font-weight: 1000;
      color: rgba(31,42,68,0.75);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      cursor:pointer;
    }
    .navBtn.active{
      background: rgba(56,195,255,0.14);
      color: rgba(31,42,68,0.95);
      box-shadow: 0 12px 18px rgba(26, 38, 64, 0.08);
    }
    .navIcon{
      font-size: 20px;
      line-height: 1;
    }

    /* å°ã•ã‚ç«¯æœ«ç”¨ */
    @media (max-width: 380px){
      h1{ font-size: 34px; }
      .menuTitle{ font-size: 38px; }
      .statInput{ font-size: 42px; }
    }
  </style>
</head>

<body>
  <div class="sparkles"></div>

  <div class="app">
    <!-- HOME -->
    <section id="homeScreen" class="screen active">
      <h1>ä»Šæ—¥ã®ä½“èª¿ã¯ï¼Ÿ</h1>

      <div class="mood-tabs" id="moodTabs">
        <div class="mood-tab active" data-mood="genki"><span class="emoji">â˜€ï¸</span><span>å…ƒæ°—</span></div>
        <div class="mood-tab" data-mood="futsu"><span class="emoji">ğŸ’™</span><span>ãµã¤ã†</span></div>
        <div class="mood-tab" data-mood="shindoi"><span class="emoji">ğŸ¥º</span><span>ã—ã‚“ã©ã„</span></div>
        <div class="mood-tab" data-mood="rest"><span class="emoji">ğŸ¾</span><span>ä¼‘æ¯</span></div>
      </div>

      <div class="panel">
        <div class="chip" id="moodChip">â˜€ï¸ å…ƒæ°—</div>

        <div class="titleRow">
          <div>
            <div class="menuTitle" id="menuTitle">Fit Boxing</div>
          </div>
        </div>

        <div class="bannerFrame">
          <img id="menuBanner" alt="menu banner" src="assets/fitboxing.png" />
        </div>

        <div class="statsRow">
          <div class="statBox">
            <div class="statLabel">ğŸ‘Ÿ ä»Šæ—¥ã®æ­©æ•°ï¼ˆç©ºæ¬„NGï¼‰</div>
            <div class="statValueRow">
              <input id="stepsInput" class="statInput" inputmode="numeric" pattern="[0-9]*" placeholder="0" />
              <div class="unit">æ­©</div>
            </div>
          </div>

          <div class="statBox">
            <div class="statLabel">ğŸ•’ é‹å‹•ï¼ˆç©ºæ¬„NGï¼‰</div>
            <div class="statValueRow">
              <input id="minsInput" class="statInput" inputmode="numeric" pattern="[0-9]*" placeholder="0" />
              <div class="unit">åˆ†</div>
            </div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn orange" id="doneBtn">âœ… ã‚„ã£ãŸï¼</button>
          <button class="btn blue" id="moreBtn">ï¼‹ ã‚‚ã†1ã¤ã‚„ã‚‹</button>
        </div>

        <div class="meta" id="metaLine">è¨˜éŒ²ï¼šâ€”</div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="historyScreen" class="screen">
      <div class="historyHeader">
        <div class="historyTitle">å±¥æ­´</div>
        <div style="display:flex; gap:10px;">
          <button class="ghostBtn" id="exportBtn">Excelå‡ºåŠ›ï¼ˆCSVï¼‰</button>
          <button class="ghostBtn" id="clearAllBtn">å…¨å‰Šé™¤</button>
        </div>
      </div>

      <div class="panel">
        <div class="historyList" id="historyList"></div>
        <div class="meta" id="historyMeta"></div>
      </div>
    </section>
  </div>

  <!-- streak overlay -->
  <div class="streakOverlay" id="streakOverlay">
    <div class="streakCard">
      <div class="streakFlame">ğŸ”¥</div>
      <div class="streakNum" id="streakNum">1</div>
      <div class="streakLabel">æ—¥é€£ç¶šè¨˜éŒ²</div>
      <div class="streakDays" id="streakDots"></div>
      <button class="streakNext" id="streakCloseBtn">æ¬¡ã¸</button>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="bottomBar">
    <div class="bottomInner">
      <button class="navBtn active" id="navHome"><span class="navIcon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></button>
      <button class="navBtn" id="navHistory"><span class="navIcon">ğŸ•’</span><span>å±¥æ­´</span></button>
    </div>
  </div>

  <script>
    // ====== ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾© ======
    const MENUS = {
      genki: [
        { name: "Ring Fit", banner: "assets/ringfit.png" },
        { name: "Fit Boxing", banner: "assets/fitboxing.png" },
        { name: "HOP!STEP!DANCE!", banner: "assets/hopstepdance.png" }
      ],
      futsu: [
        { name: "Ring Fitï¼ˆã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰", banner: "assets/ringfit.png" }
      ],
      shindoi: [
        { name: "Yoga", banner: "assets/yoga.png" }
      ],
      rest: [
        { name: "Rest", banner: "assets/rest.png" }
      ]
    };

    const MOOD_UI = {
      genki: { chip: "â˜€ï¸ å…ƒæ°—", accent: "genki" },
      futsu: { chip: "ğŸ’™ ãµã¤ã†", accent: "futsu" },
      shindoi:{ chip: "ğŸ¥º ã—ã‚“ã©ã„", accent: "shindoi" },
      rest:  { chip: "ğŸ¾ ä¼‘æ¯", accent: "rest" }
    };

    // ====== LocalStorage keys ======
    const KEY_LOGS = "workout_logs_v2";
    const KEY_TODAY_DONE = "workout_done_dates_v2"; // { "YYYY-MM-DD": true }
    const KEY_CURRENT_MOOD = "workout_current_mood_v2";
    const KEY_TODAY_MENU = "workout_today_menu_v2"; // { "YYYY-MM-DD": {mood, name, banner} }

    // ====== Helpers ======
    const $ = (id) => document.getElementById(id);
    const todayStr = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      }catch(e){
        return fallback;
      }
    }
    function saveJSON(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function clampInt(str){
      // ç©ºæ¬„ã¯ nullï¼ˆç©ºæ¬„NGåˆ¤å®šã«ä½¿ã†ï¼‰
      if (str === null || str === undefined) return null;
      const t = String(str).trim();
      if (t === "") return null;
      // 0 ã‚‚OK
      const n = parseInt(t, 10);
      if (Number.isNaN(n)) return null;
      return Math.max(0, n);
    }

    function pickMenuForToday(mood){
      const t = todayStr();
      const todayMenuMap = loadJSON(KEY_TODAY_MENU, {});
      if (todayMenuMap[t] && todayMenuMap[t].mood === mood){
        return todayMenuMap[t];
      }

      // moodåˆ¥ï¼šå…ƒæ°—ã ã‘ãƒ©ãƒ³ãƒ€ãƒ ã€ãã‚Œä»¥å¤–ã¯å›ºå®šï¼ˆå…ˆé ­ï¼‰
      let chosen;
      if (mood === "genki"){
        const arr = MENUS.genki;
        const idx = Math.floor(Math.random() * arr.length);
        chosen = { mood, ...arr[idx] };
      } else {
        const arr = MENUS[mood] || [];
        chosen = { mood, ...(arr[0] || {name:"â€”", banner:""}) };
      }

      todayMenuMap[t] = chosen;
      saveJSON(KEY_TODAY_MENU, todayMenuMap);
      return chosen;
    }

    function renderMenu(mood){
      const menu = pickMenuForToday(mood);

      $("moodChip").textContent = MOOD_UI[mood].chip;
      $("menuTitle").textContent = menu.name;
      $("menuBanner").src = menu.banner;

      // è¦‹ãŸç›®æ›´æ–°ï¼ˆã‚¿ãƒ–ã®activeï¼‰
      document.querySelectorAll(".mood-tab").forEach(el=>{
        el.classList.toggle("active", el.dataset.mood === mood);
      });

      saveJSON(KEY_CURRENT_MOOD, mood);

      // è¡¨ç¤ºãƒ¡ã‚¿
      const logs = loadJSON(KEY_LOGS, []);
      const last = logs[0];
      $("metaLine").textContent = last
        ? `è¨˜éŒ²ï¼š${last.date}, ${last.moodLabel}ï¼ˆæ­©æ•°:${last.steps} / åˆ†:${last.mins}ï¼‰`
        : "è¨˜éŒ²ï¼šâ€”";
    }

    // ====== streak ======
    function computeStreak(){
      // ã€Œãã®æ—¥ã«1å›ã§ã‚‚â€œã‚„ã£ãŸï¼â€ï¼ˆä¼‘æ¯ã‚‚å«ã‚€ï¼‰ã‚’æŠ¼ã—ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆã€
      const doneMap = loadJSON(KEY_TODAY_DONE, {});
      let streak = 0;
      let d = new Date();

      while(true){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        const k = `${y}-${m}-${day}`;
        if (doneMap[k]){
          streak++;
          d.setDate(d.getDate() - 1);
        } else {
          break;
        }
      }
      return streak;
    }

    function showStreak(){
      const streak = computeStreak();
      $("streakNum").textContent = String(streak);

      // dotsï¼ˆç›´è¿‘7æ—¥ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
      const dots = [];
      for (let i=0;i<7;i++){
        dots.push(`<div class="dot ${i<Math.min(7, streak) ? 'on':''}"></div>`);
      }
      $("streakDots").innerHTML = dots.join("");
      $("streakOverlay").classList.add("show");
    }

    function markDoneToday(){
      const map = loadJSON(KEY_TODAY_DONE, {});
      map[todayStr()] = true;
      saveJSON(KEY_TODAY_DONE, map);
    }

    // ====== logs ======
    function moodLabel(mood){
      if (mood==="genki") return "å…ƒæ°—";
      if (mood==="futsu") return "ãµã¤ã†";
      if (mood==="shindoi") return "ã—ã‚“ã©ã„";
      if (mood==="rest") return "ä¼‘æ¯";
      return mood;
    }

    function addLog({mood, menuName, steps, mins}){
      const logs = loadJSON(KEY_LOGS, []);
      logs.unshift({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date: todayStr(),
        mood,
        moodLabel: moodLabel(mood),
        menu: menuName,
        steps,
        mins,
        createdAt: new Date().toISOString()
      });
      saveJSON(KEY_LOGS, logs);
      return logs;
    }

    function renderHistory(){
      const logs = loadJSON(KEY_LOGS, []);
      const list = $("historyList");
      list.innerHTML = "";

      if (logs.length === 0){
        list.innerHTML = `<div class="meta" style="padding:10px 0;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
        $("historyMeta").textContent = "";
        return;
      }

      logs.forEach(item=>{
        const row = document.createElement("div");
        row.className = "logItem";
        row.innerHTML = `
          <div class="logLeft">
            <div class="logTop">${item.date} / ${item.moodLabel} / ${escapeHtml(item.menu)}</div>
            <div class="logSub">æ­©æ•° ${item.steps} ãƒ» é‹å‹• ${item.mins} åˆ†</div>
          </div>
          <button class="dangerBtn" data-del="${item.id}">å‰Šé™¤</button>
        `;
        list.appendChild(row);
      });

      $("historyMeta").textContent = `åˆè¨ˆï¼š${logs.length} ä»¶`;
    }

    function deleteLog(id){
      const logs = loadJSON(KEY_LOGS, []);
      const next = logs.filter(x=>x.id !== id);
      saveJSON(KEY_LOGS, next);
      renderHistory();
      // homeå´ã®ãƒ¡ã‚¿æ›´æ–°
      const mood = loadJSON(KEY_CURRENT_MOOD, "genki");
      renderMenu(mood);
    }

    function clearAll(){
      if (!confirm("å±¥æ­´ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      localStorage.removeItem(KEY_LOGS);
      // streakè‡ªä½“ã¯æ®‹ã—ã¦ã‚‚ã„ã„ãŒã€Œãƒ†ã‚¹ãƒˆã§æŠ¼ã—ãŸå±¥æ­´ã‚’æ¶ˆã—ãŸã„ã€ç”¨é€”ãªã®ã§ã€doneã‚‚æ¶ˆã™
      localStorage.removeItem(KEY_TODAY_DONE);
      localStorage.removeItem(KEY_TODAY_MENU);
      renderHistory();
      const mood = loadJSON(KEY_CURRENT_MOOD, "genki");
      renderMenu(mood);
    }

    function exportCSV(){
      const logs = loadJSON(KEY_LOGS, []);
      const header = ["date","mood","moodLabel","menu","steps","mins","createdAt"];
      const rows = [header.join(",")];

      logs.forEach(l=>{
        const line = [
          l.date,
          l.mood,
          l.moodLabel,
          csvSafe(l.menu),
          l.steps,
          l.mins,
          l.createdAt
        ].join(",");
        rows.push(line);
      });

      const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `workout_logs_${todayStr()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function csvSafe(v){
      const s = String(v ?? "");
      if (s.includes(",") || s.includes('"') || s.includes("\n")){
        return `"${s.replaceAll('"','""')}"`;
      }
      return s;
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== navigation ======
    function showScreen(name){
      $("homeScreen").classList.toggle("active", name==="home");
      $("historyScreen").classList.toggle("active", name==="history");

      $("navHome").classList.toggle("active", name==="home");
      $("navHistory").classList.toggle("active", name==="history");

      if (name==="history") renderHistory();
    }

    // ====== events ======
    document.querySelectorAll(".mood-tab").forEach(el=>{
      el.addEventListener("click", ()=>{
        const mood = el.dataset.mood;
        renderMenu(mood);
      });
    });

    $("navHome").addEventListener("click", ()=>showScreen("home"));
    $("navHistory").addEventListener("click", ()=>showScreen("history"));

    $("streakCloseBtn").addEventListener("click", ()=>{
      $("streakOverlay").classList.remove("show");
    });
    $("streakOverlay").addEventListener("click", (e)=>{
      if (e.target === $("streakOverlay")) $("streakOverlay").classList.remove("show");
    });

    $("historyList").addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-del]");
      if (!btn) return;
      const id = btn.getAttribute("data-del");
      deleteLog(id);
    });

    $("exportBtn").addEventListener("click", exportCSV);
    $("clearAllBtn").addEventListener("click", clearAll);

    $("doneBtn").addEventListener("click", ()=>{
      const steps = clampInt($("stepsInput").value);
      const mins  = clampInt($("minsInput").value);

      // ç©ºæ¬„NGï¼š0ã§ã‚‚å…¥åŠ›ã•ã‚Œã¦ã‚‹ã“ã¨ãŒå¿…è¦
      if (steps === null || mins === null){
        alert("æ­©æ•°ã¨åˆ†æ•°ã¯ç©ºæ¬„NGã§ã™ã€‚0ã§ã‚‚OKãªã®ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const mood = loadJSON(KEY_CURRENT_MOOD, "genki");
      const menu = pickMenuForToday(mood);

      addLog({ mood, menuName: menu.name, steps, mins });

      // streak: ãã®æ—¥ã«1å›ã§ã‚‚æŠ¼ã—ãŸã‚‰OKï¼ˆä¼‘æ¯ã‚‚å«ã‚€ï¼‰
      markDoneToday();

      // è¡¨ç¤ºæ›´æ–°
      renderMenu(mood);

      // streakè¡¨ç¤º
      showStreak();
    });

    $("moreBtn").addEventListener("click", ()=>{
      const mood = loadJSON(KEY_CURRENT_MOOD, "genki");

      // å…ƒæ°—ã ã‘ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚ã‚‹ã‘ã©ã€Œå†æŠ½é¸ã¯ã„ã‚‰ãªã„ã€ã®ã§ã€
      // ã“ã“ã¯ã€Œåˆ†ã‚„æ­©æ•°ã‚’è¿½åŠ ã§å…¥ã‚Œã¦æŠ¼ã™ã€ç”¨é€”ã«ã™ã‚‹ â†’ å…¥åŠ›ã ã‘ã‚¯ãƒªã‚¢
      $("stepsInput").value = "";
      $("minsInput").value = "";
      $("stepsInput").focus();
    });

    // ====== init ======
    (function init(){
      // åˆæœŸmood
      const mood = loadJSON(KEY_CURRENT_MOOD, "genki");
      renderMenu(mood);

      // å…¥åŠ›ï¼šæ•°å­—ä»¥å¤–ã‚’å¼¾ãï¼ˆã‚†ã‚‹ã‚ï¼‰
      const onlyNum = (el)=>{
        el.addEventListener("input", ()=>{
          el.value = el.value.replace(/[^\d]/g, "");
        });
      };
      onlyNum($("stepsInput"));
      onlyNum($("minsInput"));
    })();
  </script>
</body>
</html>
