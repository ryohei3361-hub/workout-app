<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>workout-app</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius:18px;

      --genki:#ffedd5;
      --futsu:#dcfce7;
      --shindoi:#e0e7ff;
      --rest:#f3f4f6;

      --accent:#2563eb;
      --accent2:#f97316;

      --tab-h:60px;
      --nav-h:78px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 50% -200px, rgba(99,102,241,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(249,115,22,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    .app{
      min-height:100vh;
      padding: 18px 16px calc(var(--nav-h) + 18px);
      max-width: 560px;
      margin: 0 auto;
    }

    .title{
      margin: 18px 0 14px;
      font-weight:900;
      letter-spacing:.02em;
      text-align:center;
      font-size: clamp(28px, 5.8vw, 44px);
    }

    /* Mood tabs */
    .moods{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 10px 0 14px;
    }
    .mood{
      border: 0;
      background: var(--card);
      border-radius: 16px;
      padding: 10px 8px;
      height: var(--tab-h);
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      font-weight:800;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease;
      user-select:none;
    }
    .mood:active{ transform: scale(.99); }
    .mood[data-key="genki"].active{ background: var(--genki); }
    .mood[data-key="futsu"].active{ background: var(--futsu); }
    .mood[data-key="shindoi"].active{ background: #ffe4e6; }
    .mood[data-key="rest"].active{ background: var(--rest); }

    .mood .emoji{font-size:18px;}
    .mood .label{font-size:14px; white-space:nowrap;}

    /* Card */
    .card{
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(6px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(17,24,39,.06);
    }
    .card-head{
      padding: 14px 14px 0;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(37,99,235,.10);
      color: #1d4ed8;
      font-weight: 900;
      font-size: 14px;
    }
    .menu-title{
      margin: 10px 0 10px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:.01em;
    }

    .banner{
      margin: 10px 14px 12px;
      border-radius: 16px;
      overflow:hidden;
      background: rgba(17,24,39,.04);
      border: 1px solid rgba(17,24,39,.06);
    }
    .banner img{
      display:block;
      width:100%;
      height:auto;
    }

    .inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 0 14px 14px;
    }
    .field{
      background: rgba(255,255,255,.95);
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(17,24,39,.08);
      box-shadow: 0 6px 16px rgba(17,24,39,.05);
    }
    .field label{
      display:block;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    .field .row{
      display:flex;
      align-items:baseline;
      gap: 8px;
    }
    .field input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 22px;
      font-weight: 900;
      color: var(--text);
      padding: 0;
    }
    .unit{
      color: var(--muted);
      font-weight: 900;
      font-size: 14px;
      white-space:nowrap;
    }

    .actions{
      padding: 0 14px 16px;
      display:grid;
      gap: 10px;
    }
    .btn{
      border:0;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight: 950;
      font-size: 18px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(17,24,39,.10);
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      background: linear-gradient(90deg, #fb923c, #f97316);
      color: white;
    }
    .btn.secondary{
      background: linear-gradient(90deg, #60a5fa, #2563eb);
      color: white;
    }
    .hint{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding: 0 14px 14px;
      font-weight: 700;
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Bottom nav */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      height: var(--nav-h);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(17,24,39,.08);
      display:flex;
      justify-content:center;
      z-index: 50;
    }
    .nav-inner{
      width: min(560px, 100%);
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:center;
      padding: 10px 18px 18px;
      gap: 10px;
    }
    .navbtn{
      border:0;
      background: transparent;
      border-radius: 16px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      cursor:pointer;
      font-weight: 950;
      color: #374151;
      transition: background .2s ease;
    }
    .navbtn.active{
      background: rgba(37,99,235,.12);
      color: #1d4ed8;
    }
    .navbtn svg{ width:22px; height:22px; }

    /* History */
    .page-title{
      font-weight: 950;
      font-size: 26px;
      margin: 18px 0 10px;
      text-align:center;
    }
    .history-tools{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin: 8px 0 12px;
    }
    .chip{
      border: 1px solid rgba(17,24,39,.12);
      background: rgba(255,255,255,.9);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 8px 16px rgba(17,24,39,.06);
    }
    .chip.danger{
      border-color: rgba(220,38,38,.25);
      background: rgba(254,226,226,.9);
      color: #b91c1c;
    }

    .list{
      display:grid;
      gap: 10px;
      margin-bottom: 10px;
    }
    .item{
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(17,24,39,.08);
      border-radius: 16px;
      box-shadow: 0 10px 20px rgba(17,24,39,.06);
      padding: 12px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    .item .meta{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .item .line1{
      font-weight: 950;
      font-size: 14px;
      color:#111827;
    }
    .item .line2{
      font-weight: 850;
      font-size: 13px;
      color: #374151;
    }
    .item .line3{
      font-weight: 750;
      font-size: 12px;
      color: var(--muted);
    }
    .del{
      border:0;
      background: rgba(220,38,38,.12);
      color:#b91c1c;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      cursor:pointer;
      white-space:nowrap;
    }

    /* Streak screen */
    .streak{
      text-align:center;
      padding: 18px 14px 8px;
    }
    .flame{
      width: 84px; height: 84px;
      margin: 8px auto 10px;
      border-radius: 22px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 55%),
                  linear-gradient(135deg, rgba(249,115,22,.25), rgba(37,99,235,.20));
      display:grid;
      place-items:center;
      box-shadow: 0 18px 30px rgba(17,24,39,.10);
      animation: pop .5s ease both;
    }
    .flame span{ font-size: 46px; }
    @keyframes pop{
      0%{ transform: scale(.7); opacity:.0;}
      100%{ transform: scale(1); opacity:1;}
    }
    .big{
      font-size: 86px;
      font-weight: 950;
      line-height: 1;
      background: linear-gradient(90deg, #f97316, #2563eb);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      margin: 6px 0 6px;
      animation: rise .55s ease both;
    }
    @keyframes rise{
      0%{ transform: translateY(10px); opacity:.0;}
      100%{ transform: translateY(0); opacity:1;}
    }
    .sub{
      font-weight: 950;
      font-size: 20px;
      margin-bottom: 12px;
      color:#111827;
      opacity:.92;
    }
    .week{
      display:flex;
      justify-content:center;
      gap: 8px;
      margin: 12px 0 14px;
      flex-wrap:wrap;
    }
    .daypill{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      font-weight: 950;
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(17,24,39,.10);
      box-shadow: 0 10px 18px rgba(17,24,39,.06);
      position:relative;
      overflow:hidden;
    }
    .daypill.done::after{
      content:"âœ“";
      position:absolute;
      inset:auto 6px 6px auto;
      font-size: 14px;
      color:#16a34a;
      background: rgba(22,163,74,.12);
      border-radius: 10px;
      padding: 2px 6px;
      font-weight: 950;
    }

    .streak-actions{
      padding: 0 14px 14px;
      display:grid;
      gap: 10px;
    }

    /* Small note */
    .note{
      margin-top: 8px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- HOME VIEW -->
    <section id="homeView" class="view active">
      <div class="title">ä»Šæ—¥ã®ä½“èª¿ã¯ï¼Ÿ</div>

      <div class="moods" role="tablist" aria-label="ä½“èª¿é¸æŠ">
        <button class="mood active" data-key="genki" role="tab" aria-selected="true">
          <span class="emoji">ğŸ”¥</span><span class="label">å…ƒæ°—</span>
        </button>
        <button class="mood" data-key="futsu" role="tab" aria-selected="false">
          <span class="emoji">ğŸ™‚</span><span class="label">ãµã¤ã†</span>
        </button>
        <button class="mood" data-key="shindoi" role="tab" aria-selected="false">
          <span class="emoji">ğŸ˜µâ€ğŸ’«</span><span class="label">ã—ã‚“ã©ã„</span>
        </button>
        <button class="mood" data-key="rest" role="tab" aria-selected="false">
          <span class="emoji">ğŸ¾</span><span class="label">ä¼‘æ¯</span>
        </button>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="badge" id="moodBadge">ğŸ”¥ å…ƒæ°—</div>
          <div class="menu-title" id="menuTitle">Fit Boxing</div>
        </div>

        <div class="banner">
          <img id="menuImage" src="assets/fitboxing.png" alt="menu banner" />
        </div>

        <div class="inputs">
          <div class="field">
            <label for="stepsInput">ä»Šæ—¥ã®æ­©æ•°ï¼ˆç©ºæ¬„NGï¼‰</label>
            <div class="row">
              <input id="stepsInput" inputmode="numeric" type="number" min="0" placeholder="0" />
              <span class="unit">æ­©</span>
            </div>
          </div>
          <div class="field">
            <label for="minsInput">é‹å‹•ï¼ˆç©ºæ¬„NGï¼‰</label>
            <div class="row">
              <input id="minsInput" inputmode="numeric" type="number" min="0" placeholder="0" />
              <span class="unit">åˆ†</span>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="doneBtn">ã‚„ã£ãŸï¼</button>
          <button class="btn secondary" id="moreBtn">ã‚‚ã†1ã¤ã‚„ã‚‹</button>
        </div>

        <div class="hint" id="todayHint">è¨˜éŒ²: ---, ---</div>
      </div>

      <div class="note">â€»ã€Œã‚„ã£ãŸï¼ã€ã¯ 1æ—¥ã«ä½•å›æŠ¼ã—ã¦ã‚‚OKã€‚ä¼‘æ¯(ğŸ¾)ã‚‚é€£ç¶šè¨˜éŒ²ã«ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚</div>
    </section>

    <!-- HISTORY VIEW -->
    <section id="historyView" class="view">
      <div class="page-title">å±¥æ­´</div>

      <div class="history-tools">
        <button class="chip" id="exportBtn">Excelå‡ºåŠ›ï¼ˆCSVï¼‰</button>
        <button class="chip danger" id="clearBtn">ãƒ†ã‚¹ãƒˆç”¨ï¼šå…¨æ¶ˆã—</button>
      </div>

      <div class="list" id="historyList"></div>

      <div class="note">å‰Šé™¤ã¯1ä»¶ãšã¤ / ã‚‚ã—ãã¯å…¨æ¶ˆã—ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰</div>
    </section>

    <!-- STREAK VIEW -->
    <section id="streakView" class="view">
      <div class="streak">
        <div class="flame"><span>ğŸ”¥</span></div>
        <div class="big" id="streakNum">0</div>
        <div class="sub">æ—¥é€£ç¶š</div>

        <div class="week" id="weekRow"></div>
        <div class="note">ç›´è¿‘7æ—¥ï¼ˆè§¦ã‚ŒãŸæ—¥ã¯âœ“ï¼‰</div>
      </div>

      <div class="streak-actions">
        <button class="btn primary" id="backHomeBtn">ãƒ›ãƒ¼ãƒ ã¸</button>
        <button class="btn secondary" id="goHistoryBtn">å±¥æ­´ã‚’è¦‹ã‚‹</button>
      </div>
    </section>
  </div>

  <!-- Bottom Nav -->
  <nav class="nav" aria-label="bottom navigation">
    <div class="nav-inner">
      <button class="navbtn active" id="navHome">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/>
        </svg>
        ãƒ›ãƒ¼ãƒ 
      </button>
      <button class="navbtn" id="navHistory">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 8v5l3 2"/>
          <path d="M3 12a9 9 0 1 0 3-6.7"/>
          <path d="M3 3v6h6"/>
        </svg>
        å±¥æ­´
      </button>
    </div>
  </nav>

  <script>
    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function todayISO(){
      // ç«¯æœ«ã®ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã§OKï¼ˆJSTç«¯æœ«æƒ³å®šï¼‰
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function loadLogs(){
      try{
        return JSON.parse(localStorage.getItem("workoutLogs") || "[]");
      }catch(e){
        return [];
      }
    }

    function saveLogs(logs){
      localStorage.setItem("workoutLogs", JSON.stringify(logs));
    }

    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }

    function moodLabel(key){
      return ({
        genki: "å…ƒæ°—",
        futsu: "ãµã¤ã†",
        shindoi: "ã—ã‚“ã©ã„",
        rest: "ä¼‘æ¯"
      })[key] || key;
    }

    function moodEmoji(key){
      return ({
        genki: "ğŸ”¥",
        futsu: "ğŸ™‚",
        shindoi: "ğŸ˜µâ€ğŸ’«",
        rest: "ğŸ¾"
      })[key] || "ğŸ™‚";
    }

    // ===== Menu Logic =====
    const assets = {
      fitboxing: "assets/fitboxing.png",
      ringfit: "assets/ringfit.png",
      hopstepdance: "assets/hopstepdance.png",
      yoga: "assets/yoga.png",
      rest: "assets/rest.png",
    };

    // å…ƒæ°—ã ã‘ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆãã®æ—¥1å›å›ºå®šï¼šå†æŠ½é¸ãªã—ï¼‰
    const genkiPool = [
      { id:"fitboxing", title:"Fit Boxing", img: assets.fitboxing },
      { id:"ringfit", title:"Ring Fit", img: assets.ringfit },
      { id:"hopstepdance", title:"HOP! STEP! DANCE!", img: assets.hopstepdance },
    ];

    function getGenkiPickForToday(){
      const keyDate = "genkiPickDate";
      const keyPick = "genkiPickId";
      const t = todayISO();
      const savedDate = localStorage.getItem(keyDate);
      const savedId = localStorage.getItem(keyPick);

      if(savedDate === t && savedId){
        const found = genkiPool.find(x => x.id === savedId);
        if(found) return found;
      }
      const pick = genkiPool[Math.floor(Math.random() * genkiPool.length)];
      localStorage.setItem(keyDate, t);
      localStorage.setItem(keyPick, pick.id);
      return pick;
    }

    function menuForMood(moodKey){
      if(moodKey === "genki"){
        return getGenkiPickForToday();
      }
      if(moodKey === "futsu"){
        return { id:"ringfit", title:"Ring Fitï¼ˆè»½ã‚ï¼‰", img: assets.ringfit };
      }
      if(moodKey === "shindoi"){
        return { id:"yoga", title:"Yoga + Stretch", img: assets.yoga };
      }
      // rest
      return { id:"rest", title:"Rest", img: assets.rest };
    }

    // ===== Streak Logic =====
    // ãƒ«ãƒ¼ãƒ«ï¼šãã®æ—¥ã«1å›ã§ã‚‚ã€Œã‚„ã£ãŸï¼ã€ã‚’æŠ¼ã—ãŸã‚‰ã€ãã®æ—¥=é”æˆæ—¥ï¼ˆä¼‘æ¯ã‚‚å«ã‚€ï¼‰
    function computeStreak(endingDateISO){
      const logs = loadLogs();
      const days = Array.from(new Set(logs.map(l => l.date))).sort();
      if(days.length === 0) return 0;

      // endingDateISO ã¾ã§ã®é€£ç¶šï¼ˆendingDateISOãŒæœªé”ã®æ—¥ãªã‚‰ 0ï¼‰
      const daySet = new Set(days);
      if(!daySet.has(endingDateISO)) return 0;

      let count = 0;
      let cursor = new Date(endingDateISO + "T00:00:00");
      while(true){
        const yyyy = cursor.getFullYear();
        const mm = String(cursor.getMonth()+1).padStart(2,'0');
        const dd = String(cursor.getDate()).padStart(2,'0');
        const iso = `${yyyy}-${mm}-${dd}`;
        if(daySet.has(iso)){
          count++;
          cursor.setDate(cursor.getDate() - 1);
        }else{
          break;
        }
      }
      return count;
    }

    function last7Days(endingDateISO){
      const d = new Date(endingDateISO + "T00:00:00");
      const arr = [];
      for(let i=6;i>=0;i--){
        const x = new Date(d);
        x.setDate(x.getDate() - i);
        const yyyy = x.getFullYear();
        const mm = String(x.getMonth()+1).padStart(2,'0');
        const dd = String(x.getDate()).padStart(2,'0');
        const iso = `${yyyy}-${mm}-${dd}`;
        const w = "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[x.getDay()];
        arr.push({iso, w});
      }
      return arr;
    }

    // ===== Views / UI =====
    const views = {
      home: $("#homeView"),
      history: $("#historyView"),
      streak: $("#streakView"),
    };

    function showView(name){
      Object.entries(views).forEach(([k,v]) => v.classList.toggle("active", k === name));
      $("#navHome").classList.toggle("active", name === "home");
      $("#navHistory").classList.toggle("active", name === "history");
    }

    let currentMood = "genki";
    let currentMenu = menuForMood(currentMood);

    function renderHome(){
      // tabs active
      $$(".mood").forEach(b=>{
        const on = b.dataset.key === currentMood;
        b.classList.toggle("active", on);
        b.setAttribute("aria-selected", on ? "true":"false");
      });

      // badge + title + img
      $("#moodBadge").textContent = `${moodEmoji(currentMood)} ${moodLabel(currentMood)}`;
      currentMenu = menuForMood(currentMood);
      $("#menuTitle").textContent = currentMenu.title;
      $("#menuImage").src = currentMenu.img;

      // hint
      $("#todayHint").textContent = `è¨˜éŒ²: ${todayISO()}, ${moodLabel(currentMood)}`;
    }

    function renderHistory(){
      const logs = loadLogs().slice().sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      const box = $("#historyList");
      box.innerHTML = "";

      if(logs.length === 0){
        const empty = document.createElement("div");
        empty.className = "note";
        empty.textContent = "å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“";
        box.appendChild(empty);
        return;
      }

      logs.forEach(l=>{
        const item = document.createElement("div");
        item.className = "item";

        const meta = document.createElement("div");
        meta.className = "meta";

        const line1 = document.createElement("div");
        line1.className = "line1";
        line1.textContent = `${l.date} / ${moodEmoji(l.mood)} ${moodLabel(l.mood)} / ${l.menuTitle}`;

        const line2 = document.createElement("div");
        line2.className = "line2";
        line2.textContent = `æ­©æ•°: ${l.steps}æ­©ã€€é‹å‹•: ${l.minutes}åˆ†`;

        const line3 = document.createElement("div");
        line3.className = "line3";
        const t = new Date(l.createdAt);
        line3.textContent = `è¨˜éŒ²æ™‚åˆ»: ${t.toLocaleString()}`;

        meta.appendChild(line1);
        meta.appendChild(line2);
        meta.appendChild(line3);

        const del = document.createElement("button");
        del.className = "del";
        del.textContent = "å‰Šé™¤";
        del.onclick = () => {
          const ok = confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
          if(!ok) return;
          const newLogs = loadLogs().filter(x => x.id !== l.id);
          saveLogs(newLogs);
          renderHistory();
        };

        item.appendChild(meta);
        item.appendChild(del);
        box.appendChild(item);
      });
    }

    function renderStreakScreen(endingDate){
      const streak = computeStreak(endingDate);
      $("#streakNum").textContent = String(streak);

      const logs = loadLogs();
      const daySet = new Set(logs.map(l => l.date));
      const week = last7Days(endingDate);

      const row = $("#weekRow");
      row.innerHTML = "";
      week.forEach(d=>{
        const p = document.createElement("div");
        p.className = "daypill" + (daySet.has(d.iso) ? " done":"");
        p.textContent = d.w;
        row.appendChild(p);
      });
    }

    // ===== Actions =====
    function readNumberOrNull(inputEl){
      const v = inputEl.value;
      if(v === "" || v === null || typeof v === "undefined") return null;
      const n = Number(v);
      if(Number.isNaN(n)) return null;
      if(n < 0) return null;
      // å°æ•°ã‚‚OKã«ã—ãŸã„ãªã‚‰ã“ã“ã‚’å¤‰ãˆã‚‰ã‚Œã‚‹ï¼ˆä»Šã¯å°æ•°ã‚‚è¨±å®¹ï¼‰
      return n;
    }

    function requireInputs(){
      const steps = readNumberOrNull($("#stepsInput"));
      const mins  = readNumberOrNull($("#minsInput"));
      if(steps === null || mins === null){
        alert("æ­©æ•°ã¨é‹å‹•åˆ†ã¯ç©ºæ¬„NGã§ã™ã€‚0ã§ã‚‚ã„ã„ã®ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return null;
      }
      return { steps, mins };
    }

    function addLog(){
      const inputs = requireInputs();
      if(!inputs) return;

      const entry = {
        id: uid(),
        date: todayISO(),
        mood: currentMood,
        menuId: currentMenu.id,
        menuTitle: currentMenu.title,
        steps: inputs.steps,
        minutes: inputs.mins,
        createdAt: Date.now(),
      };

      const logs = loadLogs();
      logs.push(entry);
      saveLogs(logs);

      // streak screen
      renderStreakScreen(entry.date);
      showView("streak");
    }

    function addAnother(){
      // ã‚‚ã†1ã¤ã‚„ã‚‹ï¼åŒã˜æ—¥ã®ãƒ­ã‚°ã‚’è¿½åŠ ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å†æŠ½é¸ã—ãªã„ï¼‰
      const inputs = requireInputs();
      if(!inputs) return;

      const entry = {
        id: uid(),
        date: todayISO(),
        mood: currentMood,
        menuId: currentMenu.id,
        menuTitle: currentMenu.title,
        steps: inputs.steps,
        minutes: inputs.mins,
        createdAt: Date.now(),
      };

      const logs = loadLogs();
      logs.push(entry);
      saveLogs(logs);

      // å…¥åŠ›ã ã‘ãƒªã‚»ãƒƒãƒˆï¼ˆã¾ãŸå…¥ã‚Œã‚‰ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
      $("#stepsInput").value = "";
      $("#minsInput").value = "";
      $("#stepsInput").focus();

      alert("è¿½åŠ ã—ã¾ã—ãŸï¼ã‚‚ã†1å›åˆ†ã‚‚è¨˜éŒ²ã§ãã¾ã™ã€‚");
    }

    function exportCSV(){
      const logs = loadLogs().slice().sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
      const header = ["date","mood","menuTitle","steps","minutes","createdAtISO"];
      const lines = [header.join(",")];

      logs.forEach(l=>{
        const row = [
          l.date,
          moodLabel(l.mood),
          `"${String(l.menuTitle).replaceAll('"','""')}"`,
          l.steps,
          l.minutes,
          new Date(l.createdAt).toISOString()
        ];
        lines.push(row.join(","));
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `workout_logs_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== Event bindings =====
    $$(".mood").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        currentMood = btn.dataset.key;
        renderHome();
      });
    });

    $("#doneBtn").addEventListener("click", addLog);
    $("#moreBtn").addEventListener("click", addAnother);

    $("#navHome").addEventListener("click", ()=> showView("home"));
    $("#navHistory").addEventListener("click", ()=>{
      renderHistory();
      showView("history");
    });

    $("#backHomeBtn").addEventListener("click", ()=> showView("home"));
    $("#goHistoryBtn").addEventListener("click", ()=>{
      renderHistory();
      showView("history");
    });

    $("#exportBtn").addEventListener("click", exportCSV);

    $("#clearBtn").addEventListener("click", ()=>{
      const ok = confirm("ã€ãƒ†ã‚¹ãƒˆç”¨ã€‘å±¥æ­´ã‚’å…¨æ¶ˆã—ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
      if(!ok) return;
      localStorage.removeItem("workoutLogs");
      renderHistory();
      alert("å…¨æ¶ˆã—ã—ã¾ã—ãŸï¼");
    });

    // ===== Init =====
    renderHome();
  </script>
</body>
</html>
